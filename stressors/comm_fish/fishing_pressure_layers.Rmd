---
title: 'Commercial Fishing Stressor Layers '
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

#Summary
The commercial fishing pressure layers are created from catch data provided by the Sea Around Us Project and net primary production data from the Vertically Generalized Production Model [(VGPM)](http://www.science.oregonstate.edu/ocean.productivity/) as described in [Behrenfeld and Falkowski (1997)](http://www.science.oregonstate.edu/ocean.productivity/references/L&O%201997a.pdf)

Two layers are created in this analysis, commercial fishing pressure from **high bycatch** gear and **low bycatch** gear. Quantifying the amount of catch caught by these different categories of fishing gear is done by combining two different pieces of information. 

1. The amount of fish catch caught per gear type was calculated for the first global Cumulative Human Impact analysis [(Halpern 2008)](http://science.sciencemag.org/content/319/5865/948).

2. Total fish catch (tons) per half degree cell globally 

The amount of catch caught per gear type has not been recalculated since 2008. The total proportion of catch caught per gear type is calculated from this original data, and then applied to the more recent catch data to get an updated estimate of catch per gear type. This assumes that the proportion of total catch caught by high and low bycatch has remained consistent since 2008.

#Updates from previous assessment

The fisheries catch data has been updated by the Sea Around Us Project and is provided at a spatial resolution of 0.5 degree. Previously, only aggregate catch at the country level was used.

***

#Data Source

**Reference**: Pauly D. and Zeller D. (Editors), 2015. Sea Around Us Concepts, Design and Data (seaaroundus.org)  
**Downloaded**: June 27, 2016 (sent by email from Ar'ash Tavakolie)  

**Description**:  Catch per half degree cell (tons)  

**Native data resolution**: 0.5 degree    

**Time range**: 1950 - 2010  

**Format**:  Tabular  

***
  
#Methods

##Setup

Load all relevant libraries including parallel processing packages.

```{r setup,message=FALSE,warning=FALSE,verbose=FALSE}

#set options for all chunks in code
knitr::opts_chunk$set(warning=FALSE, message=FALSE,fig.width = 6, fig.height = 4, fig.path = '~/github/impact_acceleration/figs/')

source("~/github/impact_acceleration/src/R/common.R")

library(parallel)
library(foreach)
library(doParallel)

# File paths

# Original data from 2008 CHI project
saup_pressures = file.path(dir_M,'git-annex/Global/SAUP-FishCatchByGearType_Halpern2008/data')

#mazu filepath    
dir_git <- file.path(dir_M,'marine_threats/impact_acceleration/v2016/stressors/comm_fish')

```


## Catch by gear type

These two rasters are at a resolution of 1km2 and were created in this [dataprep.R](https://github.com/OHI-Science/ohiprep/blob/master/globalprep/prs_fish/v2015/dataprep.R) script

```{r gear_rasters}

# Get gear catch rasters

    gear_ras <- list.files(file.path(saup_pressures), pattern = 'catch_dem|catch_pel', full.names=T)

# define gears

   gears <- c('dem_d','dem_nd_hb','dem_nd_lb','pel_hb','pel_lb')

# aggregate all catch
    
    all_catch_gcs = gear_ras%>%stack()%>%
                      calc(.,fun=function(x){sum(x,na.rm=T)},progress='text')

    catch_prop <- function(x){
      gear <- strsplit(x, "catch_")[[1]][2]
      raster(x)%>%
      overlay(.,all_catch_gcs,fun=function(x,y){x/y},filename = paste0('gear_prop/gear_prop_',gear))
      
    }
    
    mclapply(gear_ras,catch_prop,mc.cores = 5)

```

## Net Primary Production (NPP)

The Net Primary Production data was prepared in [npp.Rmd](https://cdn.rawgit.com/OHI-Science/ohiprep/master/globalprep/prs_fish/v2016/prim_productivity/npp.html).

```{r npp}

npp <- list.files(file.path(dir_M,'git-annex/globalprep/prs_fish/v2016/VGPM_primary_productivity/int/annual_npp'),pattern = 'npp_2',full.names=T)

plot(raster(npp[13]),col=cols,axes=F,main = 'Net Primary Production (mg C/m2/day) \n 2015')
```

## Annual catch 

We only use catch data from 2003 - 2010 to calculate these layers since those are the time periods where we also have primary productivity data. And we don't need to go further back than 2003 since all OHI assessments will use this time period.

```{r annual_catch, eval=F}

#these catch files were generated for OHI 2016 - grab from that repo
catch_files <- list.files('~/github/ohiprep/globalprep/prs_fish/v2016/int/annual_industrial_rasters',full.names = T)[54:61]
gear_prop_files <- list.files('gear_prop',full.names=T)

# function that takes each annual catch raster, reprojects and resamples, splits it according to high and low bycatch and then standardizes by npp for that year.

ann_catch <- function(file){
  
  yr <- substr(file,89,92)
  
  r  <- raster(file)
  
  for (i in 1:5){
    
  name <- strsplit(gear_prop_files[i],"gear_prop_")[[1]][2]%>%strsplit('_gcs.tif')
  
  g <- raster(gear_prop_files[i])
    
overlay(r,g,fun=function(x,y){x*y},filename = paste0('annual_catch/annual_catch_',name,'_',yr,'.tif',sep=''),overwrite=T)
  
  }
}

mclapply(catch_files,ann_catch, mc.cores = 6)

```

## Standardize by NPP

Total catch per cell is standardized by the NPP values. This is done because the same fishing pressure can have different impacts depending on the productivity in the region. Mean atch values are calculated across a rolling window of five years.

```{r, eval =F}

annual_files = list.files('annual_catch',full.names=T)

registerDoParallel(6)

foreach (yr = c(2003:2010)) %dopar%{
  
  for(i in 1:5){

    gear <- gears[i]
    
  #1. Get catch rasters for the yr
  cat <- annual_files[str_detect(annual_files,as.character(yr))]%>%
          .[str_detect(.,gear)]%>%
              raster()
    
  #2. get net primary production for that year
   n <- npp[substr(npp,111,114)==yr]%>%
          raster()%>%
          projectRaster(cat)%>%
          resample(.,cat)
  
  #3. Divide catch by npp and save to git-annex
  overlay(cat,n,fun=function(x,y){x/y},filename = paste0('annual_catch_npp/catch_npp_',gear,'_',yr,'.tif'), overwrite=T) 

  }
  
}
```

## Reference Point & Rescale

Within each gear designation, look at all catch data standardized by NPP from 2003 - 2010 and use the 99.99th quantile as the reference point.

```{r ref_point}

cat_npp <- list.files('annual_catch_npp',full.names=T)

registerDoParallel(5) #5 cores for 5 gears

foreach (g = gears) %dopar%{

#get data across all years
  vals <- cat_npp[str_detect(cat_npp,g)]%>%
    stack()%>%
    getValues()
  
  ref <- log(quantile(vals,prob = 0.9999,na.rm=T)+1)
  
  for(i in 2003:2010)
  
    cat <- cat_npp[str_detect(cat_npp,as.character(i))]%>%
            .[str_detect(.,g)]%>%
            raster()%>%
            calc(fun=function(x){log(x+1)})%>%
            calc(fun=function(x){ifelse(x>ref,1,x/ref)},filename = paste0('annual_catch_npp_rescale/catch_npp_rescale_',g,'_',i,'.tif'),overwrite=T)

}

```

***

#Citation information  
Pauly D. and Zeller D. (Editors), 2015. Sea Around Us Concepts, Design and Data (seaaroundus.org)