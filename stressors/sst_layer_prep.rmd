---
title: 'OHI 2016: Sea Surface Temperature Pressure Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


#Summary

This script creates the Sea Surface Temperature (SST) layer for the 2018 Rate of Change project. The methods are nearly the same as those for the 2017 global Ocean Health Index assessment, but there were some small changes to the methods that make the data more suitable for the Rate of Change project, mostly by gapfilling and preserving near coastal cells. 


***  


#Data Source

Data comes from [CoRTAD version 5](http://www.nodc.noaa.gov/sog/cortad/)

See prs_sst/v2015/dataprep.R for preparation of the "annual_pos_anomalies" data.  

**Native Data Resolution**: 4km   
**Description**: 
Cortadv5_SSTA.nc = SST anomalies (weekly SST minus weekly climatological SST), weekly data for all years, degrees Kelvin
Cortadv5_weeklySST.nc =  SST, weekly data for all years, degrees Kelvin  
**Time Range**: 1982 - 2012 (weekly averages across all years)  
**Format**: NetCDF  

***  

#Methods
1. Extreme events per year based calculated as number of times SST anomoly exceeds SST Standard Deviation based on weekly values (annual_pos_anomalies data, see v2015/dataprep.R for analysis).
2. Sum extreme events for five year periods to control for yearly variation.
3. Change in extreme events: Subtract number of extreme events for each five year period from control period (1985-1989).
4. Rescale "Change in extreme events" data to values between 0 and 1 by dividing by the 99.99th quantile among all years of data.

## Setup
```{r setup, message=F,warning=F}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',message = FALSE, warning = FALSE)

# setwd("impact_acceleration/stressors")

library(raster)
library(RColorBrewer)
library(tidyverse)
library(rgdal)
library(doParallel)
library(foreach)
library(sf)
library(gstat)

# load spatial files (ocean raster and regions shapefile)
source('../ohiprep/src/R/spatial_common.R')

cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme

land      <- regions %>%
              subset(rgn_type %in% c('land','land-disputed','land-noeez'))
land2 <- as(land, "Spatial")

regions_gcs <- readOGR(dsn = file.path(dir_M, "git-annex/globalprep/spatial/d2014/data"), layer = "regions_gcs")
```

***

### Calculate reference value
```{r, eval=FALSE}

l   <- list.files(file.path(dir_M,'git-annex/globalprep/prs_sst/v2015/tmp'), pattern='annual_pos_anomalies', full.names=TRUE)

# use the original data as mask at this spatial scale
org_data <- stack(file.path(dir_M,'git-annex/globalprep/prs_sst/data/cortadv5_SSTA.nc'), varname='SSTA')
mask_data <- org_data[[1]]

ref <- stack(grep(c('1985|1986|1987|1988|1989'), l, value=TRUE)) %>%  # Time period we are using for historical comparison (1985 - 1989)
  mask(mask_data) %>%
  sum(.)


vals <- c()

for (i in 1986:2008){ #i=2005
  
  yrs <- c(i:(i+4))
  
  s   <- stack(l[substr(l,81,84) %in% yrs]) %>% 
    sum(.)

  diff <-  overlay(s, ref, fun=function(x,y){x-y}) #calculate difference between recent 5 year cumulative sum and historical (1985-1989)

  diff_vals <- getValues(diff)
    
  vals <- c(vals, diff_vals)
  print(i)
}

    
#get min, max and 99.99th quantile

min_v <- min(vals, na.rm = TRUE)
max_v <- max(vals, na.rm = TRUE)
resc_num  <- quantile(vals, prob=0.9999, na.rm=TRUE) ### 128
hist(vals, main="SST extreme events across all years/cells")

rescale <- read.csv(file.path(dir_M, "git-annex/impact_acceleration/stressors/ref_points.csv"))
new_ref <- data.frame(pressure = "SST", 
                      reference = resc_num, 
                      method = "99.99th quantile across all raster cells and years of the number of weeks during 5 year period that exceed 1 SD of the mean across all years", 
                      date = Sys.Date()) 
rescale <- rbind(rescale, new_ref)
write.csv(rescale, file.path(dir_M, "git-annex/impact_acceleration/stressors/ref_points.csv"), row.names=FALSE)

```

## Identify gapfilled cells
```{r, eval=F}

# number of positive anomalies
l   <- list.files(file.path(dir_M,'git-annex/globalprep/prs_sst/v2015/tmp'), pattern='annual_pos_anomalies', full.names=TRUE)

# use the original data as mask at this spatial scale
org_data <- stack(file.path(dir_M,'git-annex/globalprep/prs_sst/data/cortadv5_SSTA.nc'), varname='SSTA')
mask_data <- org_data[[1]]

# identify cells that need to be gapfilled
subs_df <- data.frame(id=c(NA, 1), v = c(1, 0))
ocean_rev <- subs(ocean, subs_df)


# need to add one to sst so zero values get counted
#                        SST      SST + 2      Mask  SST+2+Mask
# land                   NA       NA           1         1
# need gapfilled ocean   NA       NA           0         0 
# ocean_rev              >= 0     >=2          0         2-??
# if ocean_rev and SST+1 are summed then the gapfilled regions will equal 1 and rest of ocean will equal 2.  Land will equal zero.

fun_plus_two <- function(x){x + 2}

file_gf = raster(l[1]) %>%
  mask(mask_data) %>%
  raster::calc(fun_plus_two) %>%   # get rid of zero values
  projectRaster(ocean, method = "ngb", over=TRUE)
  
plot(file_gf)

sum_narm = function(x,...){sum(x, na.rm=TRUE)}
file_gf <- overlay(file_gf, ocean_rev, fun=sum_narm)
file_gf_final <- cut(file_gf, breaks=c(-1, 0, 1, 100))
plot(file_gf_final, col = c("red", "white", "gray"))

# get count of gapfilled cells
file_gf_count <- getValues(file_gf_final)
gf_count <- sum(file_gf_count==1)
gf_count # 965148
ocean_vals <- getValues(ocean)
ocean_size <- sum(ocean_vals == 1, na.rm=TRUE)
ocean_size
965148/416190801 # 0.2% gapfilled

file_gf_final_mask <- mask(file_gf_final, ocean)
plot(file_gf_final_mask)

# from to
subs_df <- data.frame(id=c(3), v = c(0))
file_gf_final_mask <- subs(file_gf_final_mask, subs_df, subsWithNA=FALSE)

plot(file_gf_final_mask, col=c("lightgray", "red"))
file_gf_final_mask

writeRaster(file_gf_final_mask, file.path(dir_M, "git-annex/impact_acceleration/stressors/sst/int/sst_gf.tif"), overwrite=TRUE)

```

## interpolate each year of sst raster data, crs to mollweide/1km, mask, and save
```{r interpolate, eval=FALSE}

l   <- list.files(file.path(dir_M,'git-annex/globalprep/prs_sst/v2015/tmp'), pattern='annual_pos_anomalies', full.names=TRUE)
  
plot(raster(l[1]))
#click(raster(l[1])) # unfortunately, land areas are 0 and not NA, need to mask prior to gapfilling

# use the original data as mask at this spatial scale
org_data <- stack(file.path(dir_M,'git-annex/globalprep/prs_sst/data/cortadv5_SSTA.nc'), varname='SSTA')
mask_data <- org_data[[1]]

registerDoParallel(10)
foreach(file_name = l) %dopar%{ # file_name = l[1]
  
  yr <- substr(file_name, nchar(file_name)-7, nchar(file_name)-4)
  
  r = raster(file_name) %>%
    mask(mask_data)

  
## Gapfill using mean of surrounding cells that are NA
gf_raster <- function(x){focal(x, w = matrix(1,3,3), fun = mean, na.rm=TRUE, pad = TRUE, NAonly=TRUE)}

## Repeat 400 times (I found this was enough iterations to gapfill all missing values)
i <- 0
while (i <= 400){
r <- gf_raster(r)
i <- i + 1
print(i)
}

## project to mol with ~1 km cell size and mask using the ocean raster 
r_proj_mask <- r %>%
  projectRaster(ocean, method = "ngb", over=TRUE) %>% # definitely need over=TRUE, otherwise plots oddly for mollweide
  mask(ocean)

# plot(r_proj_mask)
writeRaster(r_proj_mask, file.path(dir_M, sprintf("git-annex/impact_acceleration/stressors/sst/int/sst_anom_interpolated_%s.tif", yr)), overwrite=TRUE)

}


```


## Create 5 year cumulative sum of extreme events and calculate difference from historical
```{r, eval=F}

  l   <- list.files(file.path(dir_M,'git-annex/impact_acceleration/stressors/sst/int'), pattern='sst_anom', full.names=TRUE)
  
plot(raster(l[1]))

# Get 5 year aggregates
ref_years <- grep(c('1985|1986|1987|1988|1989'), l, value=TRUE)

  ref <- stack(ref_years) %>% 
    sum(.) # This is the time period we are using for historical comparison (1985 - 1989)

  

for (i in 1986:2008){ #i=2005
  print(i)
  yrs <- c(i:(i+4))
  yrs_comb <- paste(yrs, collapse="|")
  s   <- stack(grep(yrs_comb, l, value=TRUE)) %>% 
    sum(.)
  
  diff = overlay(s, ref, fun=function(x,y){x-y}) #calculate difference between recent 5 year cumulative sum and historical (1985-1989)

  writeRaster(diff,
              filename = file.path(dir_M, sprintf('git-annex/impact_acceleration/stressors/sst/int/sst_diff_ocean_%s-%s.tif', yrs[1], yrs[5])), overwrite=TRUE)
}

```



## Rescaling

```{r rescale, eval=F}

diffs <- list.files(file.path(dir_M, 'git-annex/impact_acceleration/stressors/sst/int'), pattern = 'diff', full.names=TRUE)

resc_num <- read.csv(file.path(dir_M, "git-annex/impact_acceleration/stressors/ref_points.csv")) %>%
  filter(pressure == "SST") %>%
  .$reference

for (diff_rast in diffs){ # diff_rast <- diffs[23]

  print(diff_rast)

  r <- raster(diff_rast)

  yrs <- str_sub(diff_rast, -8, -5)
  
  out = raster::calc(r, fun=function(x){ifelse(x>0, 
                                       ifelse(x>resc_num, 1, x/resc_num), 
                                       0)}, 
        filename = file.path(dir_M, sprintf('git-annex/impact_acceleration/stressors/sst/final/sst_%s_rescaled_mol.tif', yrs)), overwrite=TRUE)

}

```

***

#Results

```{r results}
## these should look the same...and they do.
new <- raster(file.path(dir_M, 'git-annex/impact_acceleration/stressors/sst/final/sst_2012_rescaled_mol.tif'))
plot(new, col=cols)

res <- list.files(file.path(dir_M, 'git-annex/globalprep/prs_sst/v2016/output'), full.names = TRUE)

plot(raster(res[24]), col=cols, axes=F, main = 'Sea Surface Temperature Pressure Layer \n OHI 2016')

```

***

# Citation information  

Selig, E.R., K.S. Casey, and J.F. Bruno (2010), New insights into global patterns of ocean temperature anomalies: implications for coral reef health and management, Global Ecology and Biogeography, DOI: 10.1111/j.1466-8238.2009.00522.x.

