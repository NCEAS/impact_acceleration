
#### Slope/CHI combo region plots
```{r zoom_extremes}

region_plot_extreme=function(raster_data=chi_slope, crop_rgn=ns, saveFile="x_ns", cols=cols,
                    breaks=my_breaks){
# raster_data = chi_slope
# region_extent = africa
# saveFile = "ext_africa"  
# cols = cols  
# breaks = my_breaks  
  
## crop region
master_crop <- crop(raster_data, crop_rgn)

png(sprintf("impacts/figures/rgn_maps/%s.png",  saveFile), 
    res=500, width=6, height=5, units="in")  
  par(mar=c(2,2,2,2)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(c(crop_rgn[1], crop_rgn[2]), c(crop_rgn[3], crop_rgn[4]), 
     type="n", xaxs="i", yaxs="i", axes=FALSE)
plot(master_crop, col=cols,  
     breaks=my_breaks, 
     legend=FALSE, add=TRUE)
plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
box("plot", col="gray")
  dev.off()
}



chi_slope <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/extremes_lat_long.tif"))

my_breaks <- c(-2, -1, 0, 1, 3)
cols = c("#018AC4", "#EBC915", "#550133", "#CF2154")


region_plot_extreme(raster_data=chi_slope, crop_rgn=gomaine, saveFile="x_gomaine", cols=cols,
                    breaks=my_breaks)
region_plot_extreme(raster_data=chi_slope, crop_rgn=ns, saveFile="x_ns", cols=cols,
                    breaks=my_breaks)
region_plot_extreme(raster_data=chi_slope, crop_rgn=nz, saveFile="x_nz", cols=cols,
                    breaks=my_breaks)
region_plot_extreme(raster_data=chi_slope, crop_rgn=mad, saveFile="x_mad", cols=cols,
                    breaks=my_breaks)
x1 <- ggdraw() + draw_image("impacts/figures/rgn_maps/x_gomaine.png")
x2 <- ggdraw() + draw_image("impacts/figures/rgn_maps/x_ns.png")
x3 <- ggdraw() + draw_image("impacts/figures/rgn_maps/x_mad.png")
x4 <- ggdraw() + draw_image("impacts/figures/rgn_maps/x_nz.png")

extreme_plots <- plot_grid(x1, x2, x3, x4, nrow=1)
save_plot("impacts/figures/rgn_maps/extremes.png", extreme_plots, ncol=1, base_height=1, base_width=4)

```



# scatterplot of global eez trend and chi

```{r}

chi_global <- read.csv("impacts/zonal_data_eez/global_2013_impacts.csv") %>%
  dplyr::select(rgn_id, pressure, chi=value)
trend_global <- read.csv("impacts/zonal_data_eez/global_impacts_trend.csv") %>%
  dplyr::select(rgn_id=ocean, pressure=impact, trend=value) %>%
  mutate(rgn_id = "global") %>%
  mutate(pressure = gsub("_trend", "", pressure))
chi_3nm <- read.csv("impacts/zonal_data_eez/global_3nm_2013_impacts.csv") %>%
  dplyr::select(rgn_id, pressure, chi=value)
trend_3nm <- read.csv("impacts/zonal_data_eez/global_3nm_impacts_trend.csv") %>%
  dplyr::select(rgn_id, pressure, trend=value) %>%
  mutate(pressure = gsub("_trend", "", pressure))

g_data <- left_join(chi_global, trend_global, by=c("rgn_id", "pressure"))
s_data <- left_join(chi_3nm, trend_3nm, by=c("rgn_id", "pressure"))

plot_data <- rbind(g_data, s_data)

ggplot(plot_data, aes(x=chi, y=trend, color=rgn_id)) +
  geom_point() +
  geom_text_repel(aes(label = pressure),
                 # box.padding   = 0.35, 
                #  point.padding = 0.5,
                  segment.color = 'grey50',
                segment.size = 0.2,
                point.padding = 0.2,
                size = 4) +
  theme(legend.position="none")
```

# pairwise, correlation coefficients: 3nm
```{r}

## trend data

impact_trends <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/impacts"), full=TRUE)
impact_trends_stack <- stack(impact_trends)
chi_trend <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/chi_slope.tif"))
trend_stack <- stack(chi_trend, impact_trends_stack)

rgns_3nm <- raster::raster(file.path(dir_M, "git-annex/globalprep/spatial/v2018/rgns_3nm_offshore_mol.tif"))
plot(rgns_3nm)

rgns_3nm_global <- rgns_3nm

rgns_3nm_global[!is.na(rgns_3nm_global)] <- 1

nm3Points <- rasterToPoints(rgns_3nm_global)
plot(nm3Points)
sampleLocs <- sample(1:dim(nm3Points)[1], 1000)
samplenm3 <- nm3Points[sampleLocs,]

all3nm <- extract(trend_stack, samplenm3[,1:2], progress="text") %>%
  data.frame()
names(all3nm) <-gsub("_trend", "", names(all3nm)) 


install.packages("PerformanceAnalytics")
library("PerformanceAnalytics")

png("impacts/figures/corr_scatter_plot.png", res=600, width=8, height=8, units="in") 
chart.Correlation(all3nm, histogram=TRUE, pch=19)
dev.off()

install.packages("corrplot")
library(corrplot)
M <- cor(na.omit(all3nm))

png("impacts/figures/corr_dot_plot.png", res=600, width=8, height=8, units="in") 
corrplot.mixed(M)
dev.off()

```

# High/low trend and chi raster: 6 categories
```{r}
#################################
# Raster identifying positive slope trends 
# used to identify fast and slow increasing trends 
# (i.e. quantiles without negative slopes)
slope <- raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/trend/chi_slope.tif'))

# negative and zero slope is NA and positive slope 1
# default is right is closed, which means the interval includes the endpoint
m <- c(-Inf, 0, NA)

rclmat <- matrix(m, ncol=3, byrow=TRUE)

reclassify(slope, rclmat, 
           filename = file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/slope_pos_only.tif'), overwrite=TRUE, progress="text")

slope_pos <- raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/slope_pos_only.tif'))
plot(slope_pos)


# ###################################
# ## slope 
# 
# identify quantiles
slope_pos <- raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/slope_pos_only.tif'))
raster::quantile(slope_pos, probs=c(0.1, 0.20, 0.25, 0.5, 0.75, 0.80, 0.90))
#         10%         20%         25%         50%         75%         80%         90% 
# 0.007661559 0.013656677 0.018038137 0.047727872 0.084253892 0.093336865 0.116971181 


chi <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/cumulative_impact/chi_2013.tif"))
raster::quantile(chi, probs=c(0.1, 0.20, 0.25, 0.5, 0.75, 0.80, 0.90))
#       10%       20%       25%       50%       75%       80%       90% 
# 0.3829225 0.6165478 0.7127125 1.0453910 1.4418443 1.5580050 1.8768609 

## Identify rasters with values <20th and >80th quantiles

## Slope: Identify rasters with <=0 and >80th quantile
slope <- raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/trend/chi_slope.tif'))

m <- c(-Inf, 0, -10,
       0, 0.013656677, 0,
       0.013656677, 0.093336865, NA,
       0.093336865, Inf, 10)
rclmat <- matrix(m, ncol=3, byrow=TRUE)

reclassify(slope, rclmat,
           filename = file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/slope_neg_upper_lower_quants.tif'), overwrite=TRUE, progress="text")

slope_extreme <-  raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/slope_neg_upper_lower_quants.tif'))
plot(slope_extreme)
#freq(slope_extreme)


## CHI
chi <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/cumulative_impact/chi_2013.tif"))

m <- c(-Inf, 0.6165478, -1,   
       0.6165478, 1.5580050, NA,  
       1.5580050, Inf ,1)
rclmat <- matrix(m, ncol=3, byrow=TRUE)

reclassify(chi, rclmat, 
           filename = file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/chi_upper_lower_quants.tif'), overwrite=TRUE, progress="text")

chi_extreme <-  raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/chi_upper_lower_quants.tif'))
plot(chi_extreme)
#freq(chi_extreme)

## combine the two

chi_slope <- stack(slope_extreme, chi_extreme)
overlay(chi_slope, fun=function(x,y){x + y}, 
                    filename = file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/chi_slope_extremes_6cats.tif'), overwrite=TRUE, progress="text")

## check it out
chi_slope <- raster(file.path(dir_M, 'git-annex/impact_acceleration/impact/figures/chi_slope_extremes_6cats.tif'))
plot(chi_slope)
freq(chi_slope)
# -11  20904567 5.0%, low chi, decreasing trend
# -9  10391962 2.5%, high chi, decreasing trend
# -1  34090760 8.2%, low chi, slow increase
# 1   4572133 1.1% high chi, slow increase
# 9     41888 <1% low chi, fast increase
# 11  26935394 6.5% high chi, fast increase
# NA 648429346
# total ocean cells=416190801

my_breaks <- c(-12, -11, -9, -1, 1, 9, 12)
beyonce_palettes[[127]]
beyonce_palette(127)
# dark blue, dark brown, blue,  gray, green ,red
cols = c("#5E4FA2", "#4D343A", "#3288B0",  "#A4A192", "#94FF7B", "#9E0142")
labels=c("low/\ndecrease", "high/\ndecrease", 
         "low/\nslow increase", "high/\nslow increase", 
         "low/\nfast increase", "high/\nfast increase")

legend.shrink <- 0.6
legend.width <- 0.6
png("impacts/figures/trend/chi_trend_extremes_6_cats.png", res=600, width=6, height=3, units="in") 
par(mar=c(2, 2, 2, 2))
par(oma=c(0,0,0,0))
plot(chi_slope, col=cols, axes=FALSE, box=FALSE, breaks=my_breaks, legend=FALSE)
# add axis with fields package function:
def_breaks <- c(0, 1, 2, 3, 4, 5, 6)
fields::image.plot(chi_slope, #zlim = c(min(myBreaks), max(myBreaks)), 
           legend.only = TRUE, 
           legend.shrink=legend.shrink,
           legend.width=legend.width,
           col = cols,
           breaks=def_breaks,
           #lab.breaks=labels,
           axis.args = list(cex.axis = 0.8, at=c(0.5, 1.5, 2.5, 3.5, 4.5, 5.5), labels=labels))
plot(land, add=TRUE, border="gray80", col="gray90", lwd=0.5)
dev.off()

```


# CHI quantile plot

## Organize the quantile data
Not used anymore.

```{r}

files <- list.files("impacts/quantiles", full=TRUE, pattern=".csv")

filter_str <- function(stressor){ #stressor <- "art_fish"
stress_files <- grep(stressor, files, value=TRUE)

all_data <- c()
for (file in stress_files){ # file = stress_files[1]
  little_data <- read.csv(file)
  all_data <- rbind(all_data, little_data)
}

all_data$year <- as.numeric(str_sub(all_data$impact,-8,-5))
all_data
}

```

### Plot the CHI data
No longer using.
```{r}
library(ggrepel)

quant_names <- data.frame(quant = c("quant_1", "quant_5", "quant_50", "quant_95", "quant_99"),
                          new_name =c("1th", "5th", "50th", "95th", "99th"))

plot_data <- filter_str(stressor="chi") %>%
  mutate(quant = gsub("%", "", quant)) %>%
  mutate(quant = paste0("quant_", quant)) %>%
  filter(quant %in% c("quant_5", "quant_50", "quant_95", "quant_99")) %>%
  left_join(quant_names) %>%
  mutate(label = if_else(year == max(year), as.character(new_name), NA_character_)) %>%
  mutate(quants_plus = quants+0.4)

lvls <- unique(plot_data$year)

ggplot(plot_data, aes(x=as.factor(year), y=quants, group=quant, col=quant)) +
#  geom_point(size=3, alpha=0.7) +
  geom_line(alpha=0.7, size=2) +
  labs(x="Year", y="Cumulative human impact", title="Global quantiles") +
  scale_x_discrete(breaks = lvls[seq(1, length(lvls), by=2)]) +
  geom_text_repel(aes(label = label), na.rm=TRUE, nudge_x=-0.3, point.padding = unit(8, "points"), nudge_y = 0.1, size=4.5, segment.color=NA) +
  scale_color_discrete(guide = FALSE) +
  theme(plot.title = element_text(face="plain", hjust=0.88, size=13))

ggsave("impacts/figures/quants/chi_global_quants.png", width=6, height=5, units=c("in"), dpi=300)

```


# Trend for each eez impact barplot

```{r}

# UN georegions
un_rgn <- UNgeorgn_nm %>%
  dplyr::select(rgn_id, georegion = r1_label)

# CHI for each region
chi <- read.csv("impacts/zonal_data_eez/eez_chi_trend.csv") %>%
  dplyr::select(rgn_id, rgn_name, chi=value) %>%
  left_join(un_rgn, by="rgn_id")


# get georegion ranks based on mean chi values, and use to rank chi data
rank_georgn <- chi %>%
  group_by(georegion) %>%
  summarize(mean_chi = mean(chi),
            count = length(chi)) %>%
  arrange(mean_chi)

chi$georegion <- factor(chi$georegion, levels=rank_georgn$georegion)


### Organize the chi data and add a few extra variables to help plotting
# Including empty spaces to add a y-axes

rank_rgn <- chi %>%
  arrange(georegion, chi)

# add empty space
empty_bar <- 6
to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_rgn)) )
colnames(to_add) = colnames(rank_rgn)
to_add$rgn_name <- as.character(1:empty_bar)
rank_rgn  <- rbind(to_add, rank_rgn)

# modify region names to be shorter
rank_rgn <- rank_rgn %>%
  mutate(rgn_name_short = rgn_name, 
         rgn_name_short = gsub("Islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion          ", rgn_name_short))


# some code to orient the country labels
sequence_length = length(unique(rank_rgn$rgn_name))
first_sequence = c(1:(sequence_length%/%2)) 
second_sequence = c((sequence_length%/%2+1):sequence_length) 
first_angles = c(90 - 180/length(first_sequence) * first_sequence)
second_angles = c(-90 - 180/length(second_sequence) * second_sequence)

rank_rgn$angle <- c(first_angles,second_angles)
rank_rgn$hjust <- c(rep(0, length(first_sequence)), 
                       rep(1, length(second_sequence)))

# color for region labels
rank_rgn <- rank_rgn %>%
  mutate(rgn_name = factor(rgn_name, unique(rgn_name))) %>%
  mutate(georegion = factor(georegion, unique(georegion))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color))


########### marking georegions

# add column to identify when georegion changes
rgn_shift <- rank_rgn %>%
  mutate(georegion = ifelse(is.na(georegion), "tmp", georegion)) %>%
  mutate(georegion = as.factor(georegion)) %>%
  mutate(region_shift = as.numeric(georegion) - lag(as.numeric(georegion)), default=first(as.numeric(georegion)))

rgn_shift <- which(rgn_shift$region_shift > 0)
rgn_shift <- c(1, rgn_shift) -0.5
rgn_shift <- data.frame(rgn_shift_x=rgn_shift,
                        georegion = rank_georgn$georegion,
                        name_x= c(5, 25, 47, 70, 110, 145, 200), # 140
                        name_y=c(0.12, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1))
rgn_shift <- rgn_shift %>%
  mutate(georegion = as.character(georegion)) %>%
  mutate(georegion = ifelse(georegion == "Latin America and the Caribbean", "Latin America and\nthe Caribbean",
                            georegion))

# get impact data
impacts <- read.csv("impacts/zonal_data_eez/eez_impacts_trend.csv") %>%
  left_join(un_rgn)

# ## add some blanks to separate groups
to_add <-  data.frame( matrix(NA, empty_bar*nlevels(as.factor(impacts$pressure)), ncol(impacts)) )
colnames(to_add) <- colnames(impacts)
to_add$pressure <- rep(levels(as.factor(impacts$pressure)), each=empty_bar)
to_add$value <-  0
to_add$rgn_name <- as.character(rep(1:empty_bar, nlevels(as.factor(impacts$pressure)))) 

impacts <- rbind(to_add, impacts, to_add)


## rank of pressure categories
impacts %>%
  group_by(pressure) %>%
  summarize(mean = mean(value)) %>%
  arrange(mean)

pressure_name <- data.frame(pressure = c("sst", "oa", "slr", 
                                                  "shipping",
                                                  "nutrient", "organic", "direct_human", "light",
                                                  "pel_hb", "pel_lb", "dem_dest", "dem_nondest_hb",
                                                  "dem_nondest_lb", "art_fish"),
                            pressure_name = c("sst", "oa", "slr", 
                                              "shipping", 
                                              "nutrient pollution", "organic pollution", "direct human", "light pollution",
                                              "comm fish: pel hb", "comm fish: pel lb", "comm fish: dem dest", 
                                              "comm fish: dem nondest hb", "comm fish: dem nondest lb",
                                              "artisanal fishing"))

impacts <- impacts %>%
  left_join(pressure_name, by = "pressure")

impacts$pressure_name <- factor(impacts$pressure_name, levels=rev(pressure_name$pressure_name))
impacts$rgn_name <- factor(impacts$rgn_name, levels=unique(rank_rgn$rgn_name))


library(beyonce)

myPalette <- c(beyonce_palette(18, 15, type=c("continuous"))[1:6],
               beyonce_palette(18, 25, type=c("continuous"))[15:18],
               beyonce_palette(18, 15, type=c("continuous"))[8],
               beyonce_palette(18, 20, type=c("continuous"))[16:19])
               

## some theme stuff to make the circle plot look nice

circle_theme <- theme(axis.line=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      axis.text.x = element_blank())

# circle plot
# https://www.r-graph-gallery.com/299-circular-stacked-barplot/
p <- ggplot(data=impacts, aes(x=rgn_name, y=value, fill=pressure_name)) + 
  geom_bar(stat="identity") +
  geom_errorbar(aes(x = 1, ymin = -0.15, ymax=0.25), alpha=0)  +
  geom_text(data=rank_rgn, aes(x=rgn_name, y=0.16, label=rgn_name_short, angle=angle, hjust=hjust, color=color), inherit.aes = FALSE) +
  geom_segment(x = 5, y = 0, xend = dim(rank_rgn)[1]+1, yend = 0, colour = "black", alpha=1, size=0.5) +
  geom_segment(x = 7, y = -0.05, xend = dim(rank_rgn)[1]-1, yend = -0.05, colour = "gray", alpha=1, size=0.5) +
  annotate("text", x = c(3,3,3,3), y = c(-0.05, 0, 0.05, 0.1), label = c(-0.05, 0, 0.05, 0.1), color="darkgrey", angle=-8, size=4) +
  scale_colour_identity() +
  scale_fill_manual(values=myPalette) +
  coord_polar() +
  geom_segment(data = rgn_shift, aes(x=rgn_shift_x, xend=rgn_shift_x, y=rep(-0.05, dim(rgn_shift)[1]), yend=rep(0.2, dim(rgn_shift)[1])), colour="gray", size=0.5, inherit.aes=FALSE) +
geom_text(data=rgn_shift, aes(x=name_x, y=name_y, label=georegion), inherit.aes=FALSE, size=5) +
  #geom_point(data=chi, aes(y=chi, x=rgn_name), fill="black", shape="|", size=2.5) +
  circle_theme

p
ggsave('impacts/figures/trend/eez_trend_circleplot.jpg', height=18, width=18, units=c("in"))


  ## old code for barplot
  p <- ggplot(data=impacts, aes(x=rgn_name, id, y=value, fill=pressure_name)) + 
  geom_bar(stat="identity") +
  scale_fill_manual(values=myPalette) +
  coord_flip() +
  theme_bw() +
  labs(y="Average change in impact per year", x="") + 
  guides(fill=guide_legend(reverse=TRUE)) +
  theme(axis.text.y=element_text(size=10),
        legend.justification=c(1,0), legend.position=c(0.3,0), legend.title = element_blank()) +
  geom_point(data=chi, aes(y=chi, x=rgn_name), fill="black", shape="|", size=2.5) + 
  geom_hline(yintercept=0, color="black") +
  geom_vline(xintercept=c(rgn_shift - 0.5), color="gray") +
  annotate("text", y=0.1, x=(c(rgn_shift, 220) -2), label=c(as.character(rank_georgn$georegion)), size=5)
p
ggsave('impacts/figures/trend/eez_trend_barplot.jpg', height=25, width=10)



```

# Trend for each eez impact barplot: v2. not sst
Not going to use (probably)
```{r}

# UN georegions
un_rgn <- UNgeorgn_nm %>%
  dplyr::select(rgn_id, georegion = r1_label)

# CHI for each region
# get impact data
chi <- read.csv("impacts/zonal_data_eez/eez_impacts_trend.csv") %>%
  filter(pressure != "sst") %>%
  group_by(rgn_id, rgn_name) %>%
  summarize(chi = sum(value)) %>%
  left_join(un_rgn) %>%
  dplyr::select(rgn_id, rgn_name, chi) %>%
  left_join(un_rgn, by="rgn_id")


# get georegion ranks based on mean chi values, and use to rank chi data
rank_georgn <- chi %>%
  group_by(georegion) %>%
  summarize(mean_chi = mean(chi),
            count = length(chi)) %>%
  arrange(mean_chi)

chi$georegion <- factor(chi$georegion, levels=rank_georgn$georegion)


### Organize the chi data and add a few extra variables to help plotting
# Including empty spaces to add a y-axes

rank_rgn <- chi %>%
  arrange(georegion, chi) %>%
  data.frame()

# add empty space
empty_bar <- 6
to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_rgn)) )
colnames(to_add) = colnames(rank_rgn)
to_add$rgn_name <- as.character(1:empty_bar)
rank_rgn  <- rbind(to_add, rank_rgn)

# modify region names to be shorter
rank_rgn <- rank_rgn %>%
  mutate(rgn_name_short = rgn_name, 
         rgn_name_short = gsub("Islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion          ", rgn_name_short))


# some code to orient the country labels
sequence_length = length(unique(rank_rgn$rgn_name))
first_sequence = c(1:(sequence_length%/%2)) 
second_sequence = c((sequence_length%/%2+1):sequence_length) 
first_angles = c(90 - 180/length(first_sequence) * first_sequence)
second_angles = c(-90 - 180/length(second_sequence) * second_sequence)

rank_rgn$angle <- c(first_angles,second_angles)
rank_rgn$hjust <- c(rep(0, length(first_sequence)), 
                       rep(1, length(second_sequence)))

# color for region labels
rank_rgn <- rank_rgn %>%
  mutate(rgn_name = factor(rgn_name, unique(rgn_name))) %>%
  mutate(georegion = factor(georegion, unique(georegion))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color))


########### marking georegions

# add column to identify when georegion changes
rgn_shift <- rank_rgn %>%
  mutate(georegion = ifelse(is.na(georegion), "tmp", georegion)) %>%
  mutate(georegion = as.factor(georegion)) %>%
  mutate(region_shift = as.numeric(georegion) - lag(as.numeric(georegion)), default=first(as.numeric(georegion)))

rgn_shift <- which(rgn_shift$region_shift > 0)
rgn_shift <- c(1, rgn_shift) -0.5
rgn_shift <- data.frame(rgn_shift_x=rgn_shift,
                        georegion = rank_georgn$georegion,
                        name_x= c(25, 65, 110, 137, 160, 200, 225), # 140
                        name_y=c(0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08))
rgn_shift <- rgn_shift %>%
  mutate(georegion = as.character(georegion)) %>%
  mutate(georegion = ifelse(georegion == "Latin America and the Caribbean", "Latin America and\nthe Caribbean",
                            georegion))

# get impact data
impacts <- read.csv("impacts/zonal_data_eez/eez_impacts_trend.csv") %>%
  filter(pressure != "sst") %>%
  left_join(un_rgn)

# ## add some blanks to separate groups
to_add <-  data.frame( matrix(NA, empty_bar*nlevels(as.factor(impacts$pressure)), ncol(impacts)) )
colnames(to_add) <- colnames(impacts)
to_add$pressure <- rep(levels(as.factor(impacts$pressure)), each=empty_bar)
to_add$value <-  0
to_add$rgn_name <- as.character(rep(1:empty_bar, nlevels(as.factor(impacts$pressure)))) 

impacts <- rbind(to_add, impacts, to_add)


## rank of pressure categories
impacts %>%
  group_by(pressure) %>%
  summarize(mean = mean(value)) %>%
  arrange(mean)

pressure_name <- data.frame(pressure = c("sst", "oa", "slr", 
                                                  "shipping",
                                                  "nutrient", "organic", "direct_human", "light",
                                                  "pel_hb", "pel_lb", "dem_dest", "dem_nondest_hb",
                                                  "dem_nondest_lb", "art_fish"),
                            pressure_name = c("sst", "oa", "slr", 
                                              "shipping", 
                                              "nutrient pollution", "organic pollution", "direct human", "light pollution",
                                              "comm fish: pel hb", "comm fish: pel lb", "comm fish: dem dest", 
                                              "comm fish: dem nondest hb", "comm fish: dem nondest lb",
                                              "artisanal fishing"))

impacts <- impacts %>%
  left_join(pressure_name, by = "pressure")

impacts$pressure_name <- factor(impacts$pressure_name, levels=rev(pressure_name$pressure_name))
impacts$rgn_name <- factor(impacts$rgn_name, levels=unique(rank_rgn$rgn_name))


library(beyonce)

myPalette <- c(beyonce_palette(18, 15, type=c("continuous"))[1:6],
               beyonce_palette(18, 25, type=c("continuous"))[15:18],
               beyonce_palette(18, 15, type=c("continuous"))[8],
               beyonce_palette(18, 20, type=c("continuous"))[16:19])
               

## some theme stuff to make the circle plot look nice

circle_theme <- theme(axis.line=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      axis.text.x = element_blank())

# circle plot
# https://www.r-graph-gallery.com/299-circular-stacked-barplot/
p <- ggplot(data=impacts, aes(x=rgn_name, y=value, fill=pressure_name)) + 
  geom_bar(stat="identity") +
  geom_errorbar(aes(x = 1, ymin = -0.15, ymax=0.1), alpha=0)  +
  geom_text(data=rank_rgn, aes(x=rgn_name, y=0.12, label=rgn_name_short, angle=angle, hjust=hjust, color=color), inherit.aes = FALSE) +
  geom_segment(x = 5, y = 0, xend = dim(rank_rgn)[1]+1, yend = 0, colour = "black", alpha=1, size=0.5) +
  geom_segment(x = 7, y = -0.05, xend = dim(rank_rgn)[1]-1, yend = -0.05, colour = "gray", alpha=1, size=0.5) +
  annotate("text", x = c(3,3,3,3), y = c(-0.05, 0, 0.05, 0.1), label = c(-0.05, 0, 0.05, 0.1), color="darkgrey", angle=-8, size=4) +
  scale_colour_identity() +
  scale_fill_manual(values=myPalette) +
  coord_polar() +
  geom_segment(data = rgn_shift, aes(x=rgn_shift_x, xend=rgn_shift_x, y=rep(-0.05, dim(rgn_shift)[1]), yend=rep(0.2, dim(rgn_shift)[1])), colour="gray", size=0.5, inherit.aes=FALSE) +
geom_text(data=rgn_shift, aes(x=name_x, y=name_y, label=georegion), inherit.aes=FALSE, size=5) +
  #geom_point(data=chi, aes(y=chi, x=rgn_name), fill="black", shape="|", size=2.5) +
  circle_theme

p
ggsave('impacts/figures/trend/eez_trend_circleplot_noSST.jpg', height=18, width=18, units=c("in"))




```

### Habitat CHI heat map

```{r}

hab_chis <- list.files("impacts/zonal_data_habitat", pattern="impacts", full=TRUE)

read_habs <- function(x){read.csv(x)}
habs_list <- lapply(hab_chis, read_habs)

hab_data <- bind_rows(habs_list)

hab_names <- read.csv("habitats/habitat.csv") %>%
  dplyr::select(habitat=tif_name, name=plot_name2)

# combine habitats with same raster locations
hab_data <- hab_data %>%
  left_join(hab_names) %>%
  group_by(name, year) %>%
  summarize(impact = mean(impact)) %>%
  filter(name != "ice edge")
  
  
avg_data <- hab_data %>%
  group_by(name) %>%
  summarize(average=mean(impact)) %>%
  arrange(average)
  

hab_data$name <- factor(hab_data$name, 
                             levels = avg_data$name)


#cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # 
# #cols = rev(colorRampPalette(c("#9E0142", "#9E0142", "#9E0142",
#                               "#B91F48", "#B91F48",
#                               "#D53E4F", "#D53E4F", 
#                               "#E45549", "#E45549",
#                               "#F46D43", "#F46D43",  
#                               "#F88D51", "#F88D51",
#                               "#FDAE61", "#FDAE61", 
#                               "#FED690", #"#FED690",   
#                               "#FEEAA7",
#                                
#                               "#FFFFBF", "#FFFFBF",   "#FFFFBF",
#                               
#                               "#66C2A5",  
#                               "#3288BD", "#3288BD", 
#                               "#5E4FA2",  "#5E4FA2", "#5E4FA2"))(255)) # 

cols <- c("#9E0142",
          "#9E0041", "#B92548", "#D43E4E", "#E45649", "#F36C43", "#F98E51", "#FDAD60",  
          "#FDAE61", "#FEE08B", "#FFFFBF", "#E6F598", "#ABDDA4", "#66C2A5", "#3288BD", "#5E4FA2")

tmp <- ggplot(hab_data, aes(y=year, x=name)) +
  geom_tile(aes(fill=impact, 
                text=sprintf("habitat: %s \nyear: %s \nimpact: %s" , name, year, round(impact, 2))), color="white") +
  scale_fill_gradientn(colors=rev(cols), name="Impact") +
  ylab("") +
  xlab("") +
  theme_bw() + 
  scale_y_continuous(breaks=c(2003, 2005, 2007, 2009, 2011, 2013)) +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text.x=element_text(angle=45, hjust=1, vjust=1, size=13),
        axis.text.y=element_text(size=13),
        plot.margin=unit(c(1,1,1,1.5),"cm")) 
tmp
ggsave("impacts/figures/habitat/carpet_plot_habitat.png", width=8, height=5, units=c("in"), dpi=300)

```


# line plots of EEZ CHI
No longer using.  Couldn't get labels to look exactly right.
```{r}

un_rgn <- UNgeorgn_nm %>%
  dplyr::select(rgn_id, georegion = r1_label)

chi <-read.csv("impacts/zonal_data_eez/eez_chi.csv")  %>%
  dplyr::select(rgn_id, rgn_name, year, chi=value) %>%
  left_join(un_rgn, by="rgn_id")

chi_filter <- dplyr::filter(chi, rgn_name %in%
                       c("Dominican Republic",
                         "Jarvis Island",
                         "Singapore",
                         "Canada",
                         "Norway",
                         "Ghana",
                         "Bouvet Island")) %>%
  mutate(new_name = paste(chi_filter$rgn_name, chi_filter$georegion, sep="\n")) %>%
  mutate(label = if_else(year == max(year), as.character(new_name), NA_character_))

p <- ggplot(chi, aes(x=year, y=chi, color=georegion, group=rgn_name,
                     label=rgn_name)) +
  geom_line(alpha=0.3, size=0.3) +
  labs(y="Cumulative human impact", x="") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1, size=13),
        axis.text.y=element_text(size=13)) +
  geom_line(data=chi_filter, aes(x=year, y=chi, color=georegion, group=rgn_name), size=1, alpha=0.75) +
  #geom_text_repel(data=chi_filter, aes(label = label), na.rm=TRUE,  size=3, segment.color=NA, nudge_x=1, hjust=0, point.padding = NA, direction="y") +
  geom_text(data = chi_filter, aes(label = label, colour = georegion, x = 2013.2, y = chi), hjust = 0, size=3)+
  theme(legend.position="none") +
  xlim(2003, 2017)
# +
#   scale_x_continuous(breaks=c(2003, 2005, 2007, 2009, 2011, 2013)) 

p  
ggsave('impacts/figures/trend/chi_lineplot.jpg', height=6, width=6, units=c("in"))


gp <- plotly::ggplotly(p)
htmlwidgets::saveWidget(gp, "CHI_eez_line.html", selfcontained = TRUE)


```

# Heat map of EEZ CHI through years

```{r}

plot_data <- read.csv("impacts/zonal_data_eez/eez_chi.csv") %>%
  dplyr::select(rgn_name, year, value)

# shorten names for reporting
plot_data <- plot_data %>%
  mutate(rgn_name_short = rgn_name, 
         rgn_name_short = gsub("Islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion", rgn_name_short))


# used to sort data later on
avg <- plot_data %>%
  group_by(rgn_name_short) %>%
  summarize(average=mean(value)) %>%
  arrange(average)

avg$rgn_name_short <- factor(avg$rgn_name_short, 
              levels = avg$rgn_name_short[order(avg$average, decreasing = TRUE)]) 
  

plot_data <- plot_data %>%
  left_join(avg, by="rgn_name_short")

plot_data$rgn_name_short <- factor(plot_data$rgn_name_short, 
              levels = avg$rgn_name_short[order(avg$average, decreasing = TRUE)])

# identify high/low trend regions to label in plot

trend <- read.csv("impacts/zonal_data_eez/eez_chi_trend.csv") %>%
  arrange(value)

max_trend <- top_n(trend, 5, value) %>%
  left_join(plot_data, by="rgn_name") %>%
  dplyr::select(rgn_name_short) %>%
  unique()
min_trend <- top_n(trend, -5, value) %>%
    left_join(plot_data, by="rgn_name") %>%
  dplyr::select(rgn_name_short) %>%
  unique()

avg <- avg %>%
  mutate(id = as.numeric(rownames(avg))) %>%
  mutate(label_plot = ifelse(rgn_name_short %in% max_trend$rgn_name_short, as.character(rgn_name_short), "")) %>%
  mutate(label_plot = ifelse(rgn_name_short %in% min_trend$rgn_name_short, as.character(rgn_name_short), label_plot))

avg <- avg %>%
  mutate(col_label = ifelse(rgn_name_short %in% max_trend$rgn_name_short, "#9E0142", NA)) %>%
  mutate(col_label = ifelse(rgn_name_short %in% min_trend$rgn_name_short, "#5E4FA2", col_label))


# color palette  
tmp <- colorRampPalette(c("#9E0142", "#D53E4F", "#F46D43",  "#FDAE61"), space="Lab")
tmp(7)
cols <- c("#9E0142",
          "#9E0041", "#B92548", "#D43E4E", "#E45649", "#F36C43", "#F98E51", "#FDAD60",  
          "#FDAE61", "#FEE08B", "#FFFFBF", "#E6F598", "#ABDDA4", "#66C2A5", "#3288BD", "#5E4FA2")

tmp <- ggplot(plot_data, aes(y=year, x=rgn_name_short)) +
  geom_tile(aes(fill=value, 
      text=sprintf("region: %s \nyear: %s \npressure: %s" , rgn_name, year, round(value, 2)))) +
  scale_fill_gradientn(colors=rev(cols), name="Impact") +
    scale_y_continuous(breaks=c(2003, 2005, 2007, 2009, 2011, 2013), expand=c(0,0)) +
  scale_x_discrete(breaks=avg$label_plot, labels=avg$label_plot) + 
  ylab("") + 
  xlab("") +
coord_flip() + 
theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "gray"),
        axis.text.y=element_text(size=8, color=na.omit(avg$col_label)),
        axis.text.x=element_text(size=8),
        axis.ticks.y = element_line(size = .2)) 

tmp  

ggsave('impacts/figures/chi_eez_rugplot.jpg', height=8, width=6, units=c("in"))

tmp_plotly <- plotly::ggplotly(tmp, tooltip = "text")
htmlwidgets::saveWidget(widget=tmp_plotly, "eez_chi_heat.html", selfcontained = TRUE)


```

### density plots
## global

trend data...doesn't really work well for displaying these data.
```{r}
install.packages("ggridges")
library(ggridges)

## trend data

impact_trends <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/impacts"), full=TRUE)
impact_trends_stack <- stack(impact_trends)
chi_trend <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/chi_slope.tif"))
trend_stack <- stack(chi_trend, impact_trends_stack)

samp_n <- 10000

rand_samp <- sampleRandom(trend_stack, size=samp_n) %>%
  data.frame()

rand_samp_data <- rand_samp %>%
  gather("impact", "trend")

#write.csv(rand_samp_data, "impacts/figures/int/rand_samp_trend.csv", row.names=FALSE)

ggplot(filter(rand_samp_data, impact %in% c("chi_slope", "sst_trend")), 
              aes(x=trend, y=impact)) + 
  geom_density_ridges() +
  xlim(-0.1, 0.2)

ggplot(filter(rand_samp_data, impact %in% c("chi_slope", "sst_trend", "shipping_trend",
                                            "pel_lb_trend", "pel_hb_trend", "oa_trend")), 
              aes(x=trend, y=impact)) + 
  geom_density_ridges() +
  xlim(-0.1, 0.2)

ggplot(rand_samp_data, 
              aes(x=trend, y=impact)) + 
  geom_density_ridges(stat="identity") +
  xlim(-0.1, 0.2)
```

CHI
NOt going to work here either
```{r}
impact_files <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/stressor_impact"),
                           recursive = TRUE, pattern = "2013.tif", full="TRUE")
impact_files <- impact_files[-grep("benthic_str|uv", impact_files)]

impact_stack <- stack(impact_files)

chi <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/cumulative_impact"), full=TRUE,
                  pattern = "chi_2013")
impacts <- stack(impact_stack, chi)


samp_n <- 10000

rand_samp <- sampleRandom(impacts, size=samp_n) %>%
  data.frame()

rand_samp_data <- rand_samp %>%
  gather("impact", "value")

#write.csv(rand_samp_data, "impacts/figures/int/rand_samp_trend.csv", row.names=FALSE)


ggplot(rand_samp_data, 
              aes(x=value, y=impact)) + 
  geom_density_ridges(scale=.9, rel_min_height = 0.005) +
  xlim(0, 2) + 
  theme_ridges()

ggplot(rand_samp_data, 
              aes(x=value, y=impact, height= ..density..)) + 
  geom_density_ridges(stat="density") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  theme_ridges()


ggplot(rand_samp_data, 
              aes(x=value, y=impact)) + 
  geom_density_ridges(aes(height= ..ndensity..), scale = 1.2) +
  xlim(0, 2) + 
  theme_ridges()

ggplot(rand_samp_data, 
              aes(x=value, y=impact, height = ..density..))) + 
  geom_density_ridges(scale=.9, stat="density") +
  xlim(0, 2)

```

# Attempting another ridgeline plot for habitat data

```{r}

combos <- list.files(file.path(dir_M, "git-annex/impact_acceleration/hab_stressor_combo"),
                     pattern = "_2013", full=TRUE)

hab <- "coral_reef"
combos_hab <- grep(hab, combos, value=TRUE)

for(ch in combos_hab){ # ch=combos_hab[1]
  fn <- gsub(".tif", "", basename(ch))
  tmp <- raster(ch)
  combo_values <- values(tmp)
  combo_values <- combo_values[!is.na(combo_values)]
  vals <- data.frame(file_name = fn, values=combo_values)
  write.csv(vals, file.path(dir_M, 
          sprintf("git-annex/impact_acceleration/tmp/habitat_combo_values/%s_data.csv", fn)),
            row.names=FALSE)
  }

coral <- list.files(file.path(dir_M, "git-annex/impact_acceleration/tmp/habitat_combo_values"),
                    pattern="coral", full=TRUE)

read_habs <- function(x){read.csv(x)}


habs_list <- lapply(coral, read_habs)
coral_data <- bind_rows(habs_list)

coral_data <- coral_data %>%
  mutate(file_name = gsub("__coral_reef__2013", "", file_name))

coral_data_summary <- coral_data %>%
  group_by(file_name) %>%
  summarize(mean = mean(values),
            sd = sd(values))

ggplot(dplyr::filter(coral_data, file_name %in% c("sst", "slr", "oa", "art_fish", "shipping")), 
              aes(x=values, y=file_name)) + 
  geom_density_ridges()


```


## 3nm

trend data
```{r}

## trend data

impact_trends <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/impacts"), full=TRUE)
impact_trends_stack <- stack(impact_trends)
chi_trend <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/trend/chi_slope.tif"))
trend_stack <- stack(chi_trend, impact_trends_stack)

rgns_3nm <- raster::raster(file.path(dir_M, "git-annex/globalprep/spatial/v2018/rgns_3nm_offshore_mol.tif"))
plot(rgns_3nm)

rgns_3nm_global <- rgns_3nm

rgns_3nm_global[!is.na(rgns_3nm_global)] <- 1

nm3Points <- rasterToPoints(rgns_3nm_global)
plot(nm3Points)
sampleLocs <- sample(1:dim(nm3Points)[1], 10000)
samplenm3 <- nm3Points[sampleLocs,]

all3nm <- extract(trend_stack, samplenm3[,1:2], progress="text")


all3nm_data <- all3nm %>%
  data.frame() %>%
  tidyr::gather("impact", "trend")

#write.csv(rand_samp_data, "impacts/figures/int/rand_samp_trend.csv", row.names=FALSE)


ggplot(all3nm_data, 
              aes(x=trend, y=impact)) + 
  geom_density_ridges() +
  xlim(-0.01, 0.02)

```

