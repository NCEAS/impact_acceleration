---
title: 'Figures for Eastern Tropical Pacific: High Seas'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/ohiprep_v2018/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Some setup
```{r, echo = FALSE, message = FALSE, warning = FALSE, error=FALSE, include=FALSE}

#libraries
library(tidyr)
library(dplyr)
library(raster)
library(RColorBrewer)
library(rgdal)
library(sf)
library(fields)
library(cowplot)
library(ggplot2)
library(here)

source("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/gh-pages/src/R/spatial_common.R")


regions_mol <- as(regions, "Spatial")
regions_shape <- spTransform(regions_mol, CRS("+init=epsg:4326"))
land <- regions_shape[regions_shape$rgn_type %in% c("land", "land-disputed", "land-noeez", "eez-inland"), ]
land_wgs <- spTransform(land, CRS("+init=epsg:4326"))

pressure_name <- data.frame(pressure = c("chi", "sst", "slr", "oa", 
                                                  "shipping",
                                                  "light", "nutrient", "direct_human", "organic",
                                                  "pel_hb", "dem_nondest_hb","pel_lb", 
                                                  "dem_nondest_lb", "dem_dest", "art_fish"),
                            pressure_name = c("cumulative impact", "sea surface temp", "sea level rise", "ocean acidification",
                                              "shipping", "light pollution", 
                                              "nutrient pollution", "direct human", "organic pollution",  
                                              "pelegic high bycatch", "demersal nondest high bycatch", "pelagic low bycatch", 
                                              "demersal nondest low bycatch", "demersal destructive", "artisanal fishing"))


```


Isolate cpps and wio regions from the provided data. 
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
## Get the region maps from gdb file
## need to load this for subsequent analyses

fgdb <- "projects/abnj/spatial/CPPS_NC_Pilot_Regions.gdb"

# List all feature classes in a file geodatabase
subset(ogrDrivers(), grepl("GDB", name))
fc_list <- ogrListLayers(fgdb)
print(fc_list)

# Read the feature class 
cpps <- readOGR(dsn=fgdb, layer="cpps")
cpps <- cpps[cpps$type == "ABNJ", ]


wio <- readOGR(dsn=fgdb, layer="wio_pilot")
wio <- wio[wio$type == "ABNJ", ]
wio <- wio[wio$OBJECTID == "1", ]

```


Save a buffered area around the cpps and wio regions for plotting purposes.
```{r}
cpps_extent <- extent(cpps)+20
wio_extent <- extent(wio)+20

```


# Spatial data files
Make a mollweide shapefile version of regions for extracting raster impact data.
```{r}
cpps_mol <- spTransform(cpps, CRS(proj4string(regions_shape)))
cpps_mol <- cpps_mol[cpps_mol$type == "ABNJ", ]
writeOGR(cpps_mol, "projects/abnj/spatial", "cpps_mol", driver="ESRI Shapefile")

wio_mol <- spTransform(wio, CRS(proj4string(regions_mol)))
wio_mol <- wio_mol[wio_mol$type == "ABNJ", ]
writeOGR(wio_mol, "projects/abnj/spatial", "wio_mol", driver="ESRI Shapefile")

## Make a mollweide map, probably not necessary
# rgn_area <- readOGR("projects/abnj/spatial", "cpps_mol")
# 
# png("projects/abnj/figures/global_cpps.png", res=500, width=7, height=4, units="in")
# par(mar=c(2,2,2,2)) # bottom, left, top, and right
# par(oma=c(0,0,0,0))
# 
# plot(regions_shape, col='#e3e7ea', border=NA)
# plot(land, col='gray85', border='grey80', add=TRUE, lwd=0.5)
# plot(rgn_area, col="red", border="red", add=TRUE)
# dev.off()

```


Make lat/long raster of regions to mask relevant sections of the impact raster data.
```{r}

chi <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif")) #used for extent, etc.


raster_crop <- function(extent_file, rgn_file, fileName){
rgn_crop <- crop(chi, extent_file)
rasterize(rgn_file, rgn_crop, progress="text", 
                         filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/spatial/%s_latlong_raster.tif", fileName)), overwrite=TRUE)
}

raster_crop(cpps_extent, cpps, "cpps")
raster_crop(wio_extent, wio, "wio")

test <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/wio_latlong_raster.tif"))

```


## Create a map to describe location of cpps and wio regions

```{r}

## make map of regions

rgn_map <- function(rgn, filename){
png(sprintf("projects/abnj/figures/latlong_global_%s.png", filename), res=500, width=7, height=5, units="in")
par(mar=c(1,1,1,1)) # bottom, left, top, and right
par(oma=c(0,0,0,0))

plot(regions_shape, col='#e3e7ea', border=NA)
plot(land_wgs, col='gray85', border='grey80', add=TRUE, lwd=0.5)
plot(rgn, col="red", border="red", add=TRUE)
dev.off()
}

rgn_map(cpps, "cpps")
rgn_map(wio, "wio")


```


### Eastern Tropical Pacific 

![](figures/latlong_global_cpps.png)
![](figures/latlong_global_wio.png)


### Western Indian Ocean

![](figures/latlong_global_wio.png)


## ln fishing files 

For viewing, the fisheries files are logged to highlight regional differences. (This is for the version of the plots with the floating color scale).
```{r}
## Also display logged data (fishing only)

fish_rasters <- c(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/latlong_dem_dest_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/latlong_dem_nondest_hb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/latlong_dem_nondest_lb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/latlong_pel_hb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/latlong_pel_lb_2013.tif"))


for(fis_rast in fish_rasters){ # fis_rast = fish_rasters[1]

    file_name = paste("ln", basename(fis_rast), sep="_")

    fun <- function(x){log(x + 1)}

    calc(raster(fis_rast), fun, 
         filename=file.path(dir_M, 
                  sprintf("git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/%s", file_name)), overwrite=TRUE, progress="text")
}

check <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_dem_dest_2013.tif"))

```



## Create cropped tif files of CHI/stressor impact data in lat/long

For each impact layer, crop raster data to include only region of interest.  Two versions of the cropped data are created and saved as tif files.  The first version includes the data within the reigon boundary and an additional 20 degrees around region.  The second version includes only the data within the region boundary, and the file name includes a "mask" designation. (lat/long files created in global project, Figures.Rmd)

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

## extract the data in relevant regions to create tif files
source(here("projects/abnj/abnj_functions.R"))

## impacts
latlong_impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long"), pattern="latlong_", full=TRUE)

for(impact in latlong_impacts){ # impact = latlong_impacts[1]
 saveClippedRgn(raster_data_path=impact, mask_raster_name="cpps", crop_rgn=cpps_extent) 
}  

for(impact in latlong_impacts){ # impact = latlong_impacts[1]
 saveClippedRgn(raster_data_path=impact, mask_raster_name="wio", crop_rgn=wio_extent) 
}  

## now for chi
chi <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif") #used for extent, etc.  

saveClippedRgn(raster_data_path=chi, mask_raster_name="wio", crop_rgn=wio_extent) 
saveClippedRgn(raster_data_path=chi, mask_raster_name="cpps", crop_rgn=cpps_extent) 

## now for trend
trend <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/slope_lat_long.tif") #used for extent, etc.  

saveClippedRgn(raster_data_path=trend, mask_raster_name="wio", crop_rgn=wio_extent) 
saveClippedRgn(raster_data_path=trend, mask_raster_name="cpps", crop_rgn=cpps_extent) 


## now for ln(x+1) fishing files
fish <- list.files(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong"), full=TRUE)

for(impact in fish){ # impact = fish[1]
 saveClippedRgn(raster_data_path=impact, mask_raster_name="cpps", crop_rgn=cpps_extent) 
}  

for(impact in fish){ # impact = latlong_impacts[1]
 saveClippedRgn(raster_data_path=impact, mask_raster_name="wio", crop_rgn=wio_extent) 
}  


```



## Summarize CHI/stressor impact data for each region

Working in mollweide (equal area), convert region shapefiles to raster objects.
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

cpps_raster <- readOGR("projects/abnj/spatial", "cpps_mol")
rasterize(cpps_mol, 
          raster("/home/shares/ohi/git-annex/impact_acceleration/impact/cumulative_impact/chi_2013.tif"), 
          filename = file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/cpps_mol.tif"), progress="text")

wio_raster <- readOGR("projects/abnj/spatial", "wio_mol")
rasterize(wio_mol, 
          raster("/home/shares/ohi/git-annex/impact_acceleration/impact/cumulative_impact/chi_2013.tif"), 
          filename = file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/wio_mol.tif"), progress="text", overwrite=TRUE)

test <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/cpps_mol.tif"))

```


Using mollweide region rasters extract data from impact rasters.

```{r}
# Get chi/impact files for 2013
chi <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/cumulative_impact"), full=TRUE,
                  pattern="chi")
impact_files <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/stressor_impact"), recursive = TRUE, 
                           pattern = ".tif", full="TRUE")

impacts <- c(chi, impact_files)
impacts_2013 <- grep("2013", impacts, value=TRUE) 
impacts_2013 <- grep("uv|benthic_str", impacts_2013, value=TRUE, invert=TRUE)

impact_stack <- stack(impacts_2013)

## Extract and format data

rgn_extract <- function(rgn_name, impact_list=impact_stack){
mol_tif <- raster(file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/spatial/%s_mol.tif", rgn_name)))

impact_data <- raster::zonal(impact_list, mol_tif, fun="mean", progress="text", na.rm=TRUE)

impact_data_df <- data.frame(impact_data) %>%
  tidyr::gather("pressure", "value", -1) %>%
  dplyr::rename("rgn" = zone) %>%
  dplyr::mutate(pressure = stringr::str_sub(pressure, 1, stringr::str_length(pressure)-5)) %>%
  dplyr::mutate(rgn = rgn_name) %>%
  arrange(value)

write.csv(impact_data_df, sprintf("projects/abnj/%s_impacts.csv", rgn_name), row.names=FALSE)
}

rgn_extract("cpps")
rgn_extract(rgn_name="wio")

```


# Figures for impacts for wio and cpps regions.

### consistent color scale
Setting color scale and breaks.
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
## create pngs of maps for quick view
chi_breaks <- c(-.1, 0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95,
            1.0, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.5, 1.55, 1.6, 1.65, 1.7, 1.75, 1.8, 1.85, 1.9, 1.95,  
            2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 
            3.0, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9,
            4.0, 100
            )

chi_cols <- c("#9E0142", "#B91F48", "#D53E4F", "#F46D43", "#FDAE61",  #red
              "#FEE08B", "#FFFFBF",  #yellow
              "#EFF9FF", "#CDEBFD", "#8EC5E7", "#3288BD") #blue
              #"#EFF9FF", "#BDE4FC", "#3288BD") #oldblue
chi_cols = rev(colorRampPalette(chi_cols)(length(chi_breaks)-1)) 

#colorRampPalette(c("#EFF9FF", "#BDE4FC", "#3288BD"))(4)

chi_legend_labels <- c(0, 0.5, 1,  1.5, 2,  3, ">4")
chi_label_sequence <- c(1, 11,  21, 31, 41, 51, 62)

source(here("projects/abnj/abnj_functions.R"))

```


Same color scale: Impacts for WIO region. v1: box crop
```{r}

region="wio"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)

impact_wio <- grep("mask", impacts, value=TRUE, invert=TRUE)

for (impact_crop in impact_wio){ #impact_crop = impact_wio[2]
  
plot_impact_rgn(impact_crop, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=TRUE)
  }


# chi no label

impact_chi <- grep("chi", impact_wio, value=TRUE)
plot_impact_rgn(impact_chi, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=TRUE, title=FALSE)

# get global map for comparison

source(here("projects/abnj/abnj_functions.R"))

chi_global <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif")

plot_impact_global(chi_global, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=FALSE)
```


Same color scale: Impacts for WIO region. v2: mask crop
```{r}

region="wio"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)

impact_wio <- grep("mask", impacts, value=TRUE)

for (impact_crop in impact_wio){ #impact_crop = impact_wio[2]
  
plot_impact_rgn(impact_crop, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=TRUE, saveLoc="/fixed_scale_masked_version")
  }


# chi no label

impact_chi <- grep("chi", impact_wio, value=TRUE)
plot_impact_rgn(impact_chi, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=TRUE, title=FALSE, saveLoc="/fixed_scale_masked_version")

# get global map for comparison

source(here("projects/abnj/abnj_functions.R"))

chi_global <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif")

plot_impact_global(chi_global, region = "wio", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=FALSE, saveLoc="/fixed_scale_masked_version")
```



Same color scale: Impacts for cpps region. v1. box crop
```{r}

region="cpps"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_cpps <- grep("mask", impacts, value=TRUE, invert=TRUE)

for (impact_crop in impact_cpps){ #impact_crop = impact_wio[1]
  
plot_impact_rgn(impact_crop, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE)
  }


# chi no label

impact_chi <- grep("chi", impact_cpps, value=TRUE)
plot_impact_rgn(impact_chi, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=TRUE, title=FALSE)
  

# global map for comparison
chi_global <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif")

plot_impact_global(chi_global, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=FALSE)

```


Same color scale: Impacts for cpps region. v2. region mask
```{r}

region="cpps"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_cpps <- grep("mask", impacts, value=TRUE)

for (impact_crop in impact_cpps){ #impact_crop = impact_wio[1]
  
plot_impact_rgn(impact_crop, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, saveLoc="/fixed_scale_masked_version")
  }


# chi no label

impact_chi <- grep("chi", impact_cpps, value=TRUE)
plot_impact_rgn(impact_chi, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=TRUE, title=FALSE, saveLoc="/fixed_scale_masked_version")
  

# global map for comparison
chi_global <- file.path(dir_M, "git-annex/impact_acceleration/paper/figures/chi_lat_long_2013.tif")

plot_impact_global(chi_global, region = "cpps", 
                color_breaks = chi_breaks, cols = chi_cols, 
                legend_break_labels = chi_legend_labels, label_sequence = chi_label_sequence,
                legend=FALSE, title=FALSE, saveLoc="/fixed_scale_masked_version")

```



# Same color scale: Putting together figures

## Same color scale: putting together: CHI
```{r, echo = FALSE, message = FALSE, warning = FALSE}

## wio
global_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/global_wio_chi_lat_long_2013.png"))

plot_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio__chi_lat_long_2013.png"))


plot_grid(global_rgn, plot_rgn, nrow=1,  rel_widths =c(1, 0.605)) + 
  draw_label("cumulative impact", 0.11, .82, size=18)

ggsave("projects/abnj/figures/final_figs/wio_chi_2013.png", dpi=300, width=10, height=5, units=c("in"))

## cpps

global_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/global_cpps_chi_lat_long_2013.png"))

plot_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps__chi_lat_long_2013.png"))


plot_grid(global_rgn, plot_rgn, nrow=1,  rel_widths =c(1, 0.605)) + 
  draw_label("cumulative impact", 0.11, .82, size=18)

ggsave("projects/abnj/figures/final_figs/cpps_chi_2013.png", dpi=300, width=10, height=5, units=c("in"))


```

### Same color scale: putting together: wio
```{r, echo = FALSE, message = FALSE, warning = FALSE}

## climate-change
rgn_sst <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_sst_2013.png"))
rgn_oa <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_oa_2013.png"))

cc <- plot_grid(rgn_sst, rgn_oa, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("climate change impact", 0.05, 0.95, size=16, hjust=0)

##shipping
rgn_shipping <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_shipping_2013.png"))

shipping <- plot_grid(rgn_shipping, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("shipping impact", 0.05, 0.95, size=16, hjust=0)

##pelagic
rgn_pel_hb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_pel_hb_2013.png"))

rgn_pel_lb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_pel_lb_2013.png"))

pelagic <- plot_grid(rgn_pel_hb, rgn_pel_lb, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial pelagic fishing impact", 0.05, 0.95, size=16, hjust=0)

##demersal
rgn_dd <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/wio_dem_dest_2013.png"))

dem <- plot_grid(rgn_dd, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial demersal destructive fishing impact", 0.05, 0.95, size=16, hjust=0)

## together

plot_grid(cc, shipping, pelagic, dem, nrow=4)

ggsave("projects/abnj/figures/final_figs/wio_same_scale_2013.png", dpi=300, width=10, height=22, units=c("in"))


```


### Same color scale: cpps
```{r, echo = FALSE, message = FALSE, warning = FALSE}

## climate-change
rgn_sst <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps_sst_2013.png"))
rgn_oa <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps_oa_2013.png"))

cc <- plot_grid(rgn_sst, rgn_oa, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("climate change impact", 0.05, 0.95, size=16, hjust=0)

##shipping
rgn_shipping <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps_shipping_2013.png"))

shipping <- plot_grid(rgn_shipping, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("shipping impact", 0.05, 0.95, size=16, hjust=0)

##pelagic
rgn_pel_hb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps_pel_hb_2013.png"))

rgn_pel_lb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/cpps_pel_lb_2013.png"))

pelagic <- plot_grid(rgn_pel_hb, rgn_pel_lb, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial pelagic fishing impact", 0.05, 0.95, size=16, hjust=0)

## together

plot_grid(cc, shipping, pelagic, nrow=3)

ggsave("projects/abnj/figures/final_figs/cpps_same_scale_2013.png", dpi=300, width=10, height=16.5, units=c("in"))


```




### floating color scale
Setting color scale and breaks.
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

chi_cols <- c("#9E0142", "#AA0E44", "#B61B47", "#C2294A", "#CE374D", "#DB484C", "#E95D47", "#F57446", "#F99153", "#FDAE61", #red
              "#FEE08B", "#FFFFBF",  #yellow
              "#EFF9FF", "#BDE4FC", "#3288BD") #oldblue
chi_cols = rev(colorRampPalette(chi_cols)(100)) 

#colorRampPalette(c("#9E0142", "#B91F48", "#D53E4F", "#F46D43", "#FDAE61"))(10)

source(here("projects/abnj/abnj_functions.R"))

```


floating color scale: Impacts for WIO region. v1. box crop
```{r}

region="wio"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_wio <- grep("mask", impacts, value=TRUE, invert=TRUE)

for (impact_crop in impact_wio){ #impact_crop = impact_wio[20]
  
plot_impact_rgn_no_brks(impact_crop, region = "wio", 
                cols = chi_cols, 
                legend=TRUE)
  }


```

floating color scale: Impacts for WIO region. v2. rgn mask
```{r}

region="wio"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_wio <- grep("mask", impacts, value=TRUE)

for (impact_crop in impact_wio){ #impact_crop = impact_wio[20]
  
plot_impact_rgn_no_brks(impact_crop, region = "wio", 
                cols = chi_cols, 
                legend=TRUE, saveLoc="/float_scale_mask_version")
  }


```

floating color scale: Impacts for cpps region. v1. box crop
```{r}

region="cpps"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_cpps <- grep("mask", impacts, value=TRUE, invert=TRUE)

for (impact_crop in impact_cpps){ #impact_crop = impact_cpps[1]
  
plot_impact_rgn_no_brks(impact_crop, region = "cpps", 
                cols = chi_cols, 
                legend=TRUE)
  }


```

floating color scale: Impacts for cpps region. v2. rgn mask
```{r}

region="cpps"

impacts <- list.files(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files"), pattern=region, full=TRUE)

# focus on bounded (vs. clipped) area for now (will change if desired)
impact_cpps <- grep("mask", impacts, value=TRUE)

for (impact_crop in impact_cpps){ #impact_crop = impact_cpps[1]
  
plot_impact_rgn_no_brks(impact_crop, region = "cpps", 
                cols = chi_cols, 
                legend=TRUE, saveLoc="/float_scale_mask_version")
  }


```



### floating color scale: putting together: wio
```{r, echo = FALSE, message = FALSE, warning = FALSE}

## climate-change
rgn_sst <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio_sst_2013.png"))
rgn_oa <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio_oa_2013.png"))

cc <- plot_grid(rgn_sst, rgn_oa, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("climate change impact", 0.05, 0.95, size=16, hjust=0)

##shipping
rgn_shipping <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio_shipping_2013.png"))

shipping <- plot_grid(rgn_shipping, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("shipping impact", 0.05, 0.95, size=16, hjust=0)

##pelagic
rgn_pel_hb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio__lnpel_hb_2013.png"))

rgn_pel_lb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio__lnpel_lb_2013.png"))

pelagic <- plot_grid(rgn_pel_hb, rgn_pel_lb, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial pelagic fishing impact", 0.05, 0.95, size=16, hjust=0)

##demersal
rgn_dd <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_wio__lndem_dest_2013.png"))

dem <- plot_grid(rgn_dd, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial demersal destructive fishing impact", 0.05, 0.95, size=16, hjust=0)

## together

plot_grid(cc, shipping, pelagic, dem, nrow=4)

ggsave("projects/abnj/figures/final_figs/wio_float_scale_2013.png", dpi=300, width=10, height=22, units=c("in"))


```


### Floating color scale: cpps
```{r, echo = FALSE, message = FALSE, warning = FALSE}

## climate-change
rgn_sst <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_cpps_sst_2013.png"))
rgn_oa <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_cpps_oa_2013.png"))

cc <- plot_grid(rgn_sst, rgn_oa, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("climate change impact", 0.05, 0.95, size=16, hjust=0)

##shipping
rgn_shipping <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_cpps_shipping_2013.png"))

shipping <- plot_grid(rgn_shipping, NULL, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("shipping impact", 0.05, 0.95, size=16, hjust=0)

##pelagic
rgn_pel_hb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_cpps__lnpel_hb_2013.png"))

rgn_pel_lb <- ggdraw() + draw_image(here("projects/abnj/figures/rgn_maps/floating_color_scale/float_scale_cpps__lnpel_lb_2013.png"))

pelagic <- plot_grid(rgn_pel_hb, rgn_pel_lb, nrow=1,  rel_widths =c(1, 1)) + 
  draw_label("commercial pelagic fishing impact", 0.05, 0.95, size=16, hjust=0)

## together

plot_grid(cc, shipping, pelagic, nrow=3)

ggsave("projects/abnj/figures/final_figs/cpps_float_scale_2013.png", dpi=300, width=10, height=16.5, units=c("in"))


```



##### Trend plots!





















## Change in Cumulative Human Impacts

# Arguments for trend maps
```{r}

# update if necessary
```

# Make the global map

```{r}

# update if necessary

```


# Make regional map
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

# update if necessary

```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
global_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/ben_cpps_Oct19_2018_int/trend_global.png"))

plot_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/ben_cpps_Oct19_2018_int/trend_cpps.png"))

plot_grid(global_rgn, plot_rgn, ncol=1, labels=c("", ""))

ggsave("projects/abnj/figures/ben_cpps_Oct19_2018/Trend_cumulative_human_impact.png", dpi=300, width=5, height=5, units=c("in"))

## 2nd version with non-sig trend as white
global_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/ben_cpps_Oct19_2018_int/trend_global_v2.png"))

plot_rgn <- ggdraw() + draw_image(here("projects/abnj/figures/ben_cpps_Oct19_2018_int/trend_cpps_v2.png"))

plot_grid(global_rgn, plot_rgn, ncol=1, labels=c("", ""))

ggsave("projects/abnj/figures/ben_cpps_Oct19_2018/Trend_cumulative_human_impact_v2.png", dpi=300, width=5, height=5, units=c("in"))

```



## Impact contributions
The following impacts are not included because they had no impact on this region:

* artisanal fishing
* direct human
* land-based nutrient pollution 
* land-based organic pollution
* light pollution

# Figure showing relative contribution of different impacts in the region

## Get relevant data
```{r}

pacific <- read.csv("projects/abnj/cpps_impacts.csv") 
ind <- read.csv("projects/abnj/wio_impacts.csv") 

# global values:
global_chi <- read.csv("paper/zonal_data_eez/global_chi.csv") %>%
  filter(year==2013) %>%
  dplyr::select(rgn, pressure, value)
  
global <- read.csv("paper/zonal_data_eez/global_2013_impacts.csv") %>%
  dplyr::select(rgn=rgn_id, pressure, value) %>%
  filter(pressure != "benthic_str") %>%
  bind_rows(global_chi)


impacts <- bind_rows(pacific, ind, global) %>%
  mutate(value = round(value, 5))
impacts_compare <- spread(impacts, rgn, value)

write.csv(impacts_compare, "projects/abnj/impacts_compare.csv", row.names=FALSE)
```

## Some details for plotting

```{r}


impact_name <- data.frame(pressure = c("sst", "oa", "slr", 
                                                  "shipping",
                                                  "nutrient", "organic", "direct_human", "light",
                                                  "pel_hb", "pel_lb", "dem_dest", "dem_nondest_hb",
                                                  "dem_nondest_lb", "art_fish"),
                            impact_name = c("sst", "oa", "slr", 
                                              "shipping", 
                                              "nutrient pollution", "organic pollution", "direct human", "light pollution",
                                              "fish: pel hb", "fish: pel lb", "fish: dem dest", 
                                              "fish: dem nondest hb", "fish: dem nondest lb",
                                              "artisanal fishing"),
                          impact_category = c(rep("climate change", 3), "shipping",
                                              rep("land-based", 4), rep("fishing", 6)))

impacts_plot <- impacts %>%
  left_join(impact_name) %>%
  arrange(rgn, value)

impacts_plot$impact_name <- factor(impacts_plot$impact_name, levels=rev(impacts_plot$impact_name[impacts_plot$rgn == "cpps"]))
impacts_plot$impact_category <- factor(impacts_plot$impact_category, 
                                       levels=c("climate change", "shipping", "fishing", "land-based"))



```

## Create the plot!
```{r}

library(ggplot2)
library(beyonce)

ggplot(filter(impacts_plot, rgn=="cpps" & pressure != "chi"), aes(x=impact_name, y=value, fill=impact_category)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values = beyonce_palette(129), name="impact\ncategory") +
  ylab("impact") +
  theme(legend.justification = c(1, 1), legend.position = c(1, 1),
        axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x=element_blank()) +
  geom_point(data=filter(impacts_plot, rgn=="global" & pressure != "chi"), 
             aes(x=impact_name, y=value, color=impact_category), shape = "-", size=7, inherit.aes = FALSE) +
  scale_color_manual(values = beyonce_palette(129), name="impact\ncategory", guide=FALSE) 


ggsave("projects/abnj/figures/cpps_impacts_bar_plot.png", width=10, height=5, dpi=300)


ggplot(filter(impacts_plot, rgn=="wio" & pressure != "chi"), aes(x=impact_name, y=value, fill=impact_category)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values = beyonce_palette(129), name="impact\ncategory") +
  ylab("impact") +
  theme(legend.justification = c(1, 1), legend.position = c(1, 1),
        axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x=element_blank()) +
  geom_point(data=filter(impacts_plot, rgn=="global" & pressure != "chi"), 
             aes(x=impact_name, y=value, color=impact_category), shape = "-", size=7, inherit.aes = FALSE) +
  scale_color_manual(values = beyonce_palette(129), name="impact\ncategory", guide=FALSE) 


ggsave("projects/abnj/figures/wio_impacts_bar_plot.png", width=10, height=5, dpi=300)

```


### Save tif files of impacts/regions

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
# create climate change rasters

saveClippedRgn(raster_data=sst,  mask_raster_name="cpps", crop_rgn=cpps_extent, filename="sst_cpps")
saveClippedRgn(raster_data=sst,  mask_raster_name="wio", crop_rgn=wio_extent, filename="sst_wio")


```

#### Combine climate change plots

# function
```{r, echo = FALSE, message = FALSE, warning = FALSE}

global_region_plot <- function(global_fig, cpps_fig, filename){

  global_rgn <- ggdraw() + draw_image(here(
  sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png", global_fig)))

plot_rgn <- ggdraw() + draw_image(here(
  sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png", cpps_fig)))

plot_grid(global_rgn, plot_rgn, ncol=1, labels=c("", ""))

ggsave(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018/%s.png", filename), dpi=300, width=5, height=5, units=c("in"))
}

```

## Combine
```{r}
global_region_plot(global_fig = "sst_global", cpps_fig="sst_cpps", filename="SST")

global_region_plot(global_fig = "oa_global", cpps_fig="oa_cpps", filename="OA")

global_region_plot(global_fig = "slr_global", cpps_fig="slr_cpps", filename="SLR")

```

### Shipping
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
# create shipping raster
cols = rev(colorRampPalette(c("#9E0142", "#AE1245", "#BE2449", "#CE364D", "#DA464C", "#E35449", "#EC6145", "#F47044", "#F7834D", "#F99756", "#FCAA5F",             
               "#FEF0A7", "#F3FAAD",  
              "#CAE99D", "#7ECBA4", "#3B92B8"))(254))

shipping <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_shipping_2013.tif"))

ship_plot_function <- function(ship_rast, cols=cols, saveFile, title=""){
  #cc_rast=sst
  #saveFile="sst_global"
  # cols=cols
png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=7, height=4, units="in")  
  par(mar=c(1,1,1,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(ship_rast, col=cols,  
     breaks=c(-.1, seq(minValue(shipping),
                  maxValue(shipping), length.out=254)), 
     legend=FALSE, axes=FALSE, box=FALSE)
  title(main=list(title, cex=1.2), line=0)
plot(land, add=TRUE, border="gray80", col="gray90", lwd=0.5)
par(mfrow=c(1, 1), mar=c(2, 0, 1, 0), new=FALSE)
plot(ship_rast, legend.only=TRUE, legend.shrink=.7, legend.width=.5, col=cols, axis.args = list(cex.axis = 0.6))
  dev.off()
}

shipping <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_shipping_2013.tif"))
ship_plot_function(ship_rast=shipping, cols=cols, title = "Shipping", saveFile="shipping_global")


```

# Get regional shipping data
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}


ship_region_plot <- function(raster_data, rgn_shape, crop_rgn, saveFile, cols){

## crop region
cc_crop <- crop(raster_data, crop_rgn)

## Save rasters of files
writeRaster(cc_crop, file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/clipped_files/%s.tif", saveFile)), overwrite=TRUE)
# save a 2nd version of cropped file as tif
cpps_raster <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/cpps_latlong_raster.tif"))
mask(cc_crop, cpps_raster, 
     file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/clipped_files/rgn_only_%s.tif", saveFile)), overwrite=TRUE)
# check <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files/rgn_only_sst_cpps.tif"))
# plot(check)


png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=5, height=4, units="in")  
  par(mar=c(1,1,0,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(c(crop_rgn[1], crop_rgn[2]), c(crop_rgn[3], crop_rgn[4]), 
     type="n", xaxs="i", yaxs="i", axes=FALSE)
plot(cc_crop, col=cols,  
     breaks=seq(minValue(shipping),
                  maxValue(shipping), length.out=255), 
     legend=FALSE, add=TRUE)
plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
plot(rgn_shape, add=TRUE, border="red", col=NA)
box("plot", col="gray")
  dev.off()
}

ship_region_plot(raster_data=shipping, crop_rgn=cpps_extent, rgn_shape=cpps, saveFile="shipping_cpps", cols=cols)


```

```{r, echo = FALSE, message = FALSE, warning = FALSE}


global_region_plot(global_fig = "shipping_global", cpps_fig="shipping_cpps", filename="Shipping")

```

### Fishing


```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
# prepare fishing rasters

cols = rev(colorRampPalette(c("#9E0142", "#AE1245", "#BE2449", "#CE364D", "#DA464C", "#E35449", "#EC6145", "#F47044", "#F7834D", "#F99756", "#FCAA5F",             
               "#FEF0A7", "#F3FAAD",  
              "#CAE99D", "#7ECBA4", "#3B92B8"))(254))


# figure out biggest values among fishing rasters

dd <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_dest_2013.tif"))
dnd_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_nondest_hb_2013.tif"))
dnd_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_nondest_lb_2013.tif"))
pel_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_pel_hb_2013.tif"))
pel_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_pel_lb_2013.tif"))

# all scaled to demersal non destructive high bycatch
fish_plot_function <- function(fis_rast, cols=cols, title="", saveFile){
  #cc_rast=sst
  #saveFile="sst_global"
  # cols=cols
png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=7, height=4, units="in")  
  par(mar=c(1,1,1,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(fis_rast, col=cols,  
     breaks=c(seq(minValue(dnd_hb),
                  maxValue(dnd_hb), length.out=254)), 
     legend=FALSE, axes=FALSE, box=FALSE)

title(main=list(title, cex=1.2), line=0)

plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
par(mfrow=c(1, 1), mar=c(2, 0, 1, 0), new=FALSE)
plot(dnd_hb, legend.only=TRUE, legend.shrink=.7, legend.width=.5, col=cols, axis.args = list(cex.axis = 0.6))
  dev.off()
}

fish_plot_function(fis_rast=dd, cols=cols, saveFile="fis_dd_global", title="Fishing: demersal destructive")

fish_plot_function(fis_rast=dnd_hb, cols=cols, saveFile="fis_dnd_hb_global", title = "Fishing: demersal nondestructive high bycatch")

fish_plot_function(fis_rast=dnd_lb, cols=cols, saveFile="fis_dnd_lb_global", title="Fishing: demersal nondestructive low bycatch")

fish_plot_function(fis_rast=pel_hb, cols=cols, saveFile="fis_pel_hb_global", title="Fishing: pelagic high bycatch")

fish_plot_function(fis_rast=pel_lb, cols=cols, saveFile="fis_pel_lb_global", title = "Fishing: pelagic low bycatch")


```

# Fisheries region zoom
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

fish_region_plot <- function(raster_data, rgn_shape, crop_rgn, saveFile, cols){

## crop region
cc_crop <- crop(raster_data, crop_rgn)

## Save rasters of files
writeRaster(cc_crop, file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/clipped_files/%s.tif", saveFile)), overwrite=TRUE)
# save a 2nd version of cropped file as tif
cpps_raster <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/spatial/cpps_latlong_raster.tif"))
mask(cc_crop, cpps_raster, 
     file.path(dir_M, sprintf("git-annex/impact_acceleration/projects/abnj/clipped_files/rgn_only_%s.tif", saveFile)), overwrite=TRUE)
# check <- raster(file.path(dir_M, "git-annex/impact_acceleration/projects/abnj/clipped_files/rgn_only_sst_cpps.tif"))
# plot(check)


png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=5, height=4, units="in")  
  par(mar=c(1,1,0,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(c(crop_rgn[1], crop_rgn[2]), c(crop_rgn[3], crop_rgn[4]), 
     type="n", xaxs="i", yaxs="i", axes=FALSE)
plot(cc_crop, col=cols,  
     breaks=seq(minValue(dnd_hb),
                  maxValue(dnd_hb), length.out=255), 
     legend=FALSE, add=TRUE)
plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
plot(rgn_shape, add=TRUE, border="red", col=NA)
box("plot", col="gray")
  dev.off()
}

fish_region_plot(raster_data=dd, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="dd_cpps", cols=cols)

fish_region_plot(raster_data=dnd_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="dnd_hb_cpps", cols=cols)

fish_region_plot(raster_data=dnd_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="dnd_lb_cpps", cols=cols)

fish_region_plot(raster_data=pel_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="pel_hb_cpps", cols=cols)

fish_region_plot(raster_data=pel_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="pel_lb_cpps", cols=cols)


```

#### Make combined figs
```{r, echo = FALSE, message = FALSE, warning = FALSE}

global_region_plot(global_fig = "fis_dd_global", cpps_fig="dd_cpps", filename="fish_dd")

global_region_plot(global_fig = "fis_dnd_hb_global", cpps_fig="dnd_hb_cpps", filename="fish_ndd_hb")

global_region_plot(global_fig = "fis_dnd_lb_global", cpps_fig="dnd_lb_cpps", filename="fish_ndd_lb")

global_region_plot(global_fig = "fis_pel_hb_global", cpps_fig="pel_hb_cpps", filename="fish_pel_hb")

global_region_plot(global_fig = "fis_pel_lb_global", cpps_fig="pel_lb_cpps", filename="fish_pel_lb")

```

# Logged version of fisheries pressures

# Calculate logged version of the data
```{r}
## Also display logged data (fishing only)

fish_rasters <- c(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_dest_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_nondest_hb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_dem_nondest_lb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_pel_hb_2013.tif"),
                file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/latlong_pel_lb_2013.tif"))



for(fis_rast in fish_rasters){ # fis_rast = fish_rasters[1]

    file_name = paste("ln", basename(fis_rast), sep="_")

    fun <- function(x){log(x + 1)}

    calc(raster(fis_rast), fun, 
         filename=file.path(dir_M, 
                  sprintf("git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/%s", file_name)), overwrite=TRUE, progress="text")
}

check <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_dem_dest_2013.tif"))

```


```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}
# prepare fishing rasters

cols = rev(colorRampPalette(c("#9E0142", "#AE1245", "#BE2449", "#CE364D", "#DA464C", "#E35449", "#EC6145", "#F47044", "#F7834D", "#F99756", "#FCAA5F",             
               "#FEF0A7", "#F3FAAD",  
              "#CAE99D", "#7ECBA4", "#3B92B8"))(254))



dd <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_dem_dest_2013.tif"))
dnd_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_dem_nondest_hb_2013.tif"))
dnd_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_dem_nondest_lb_2013.tif"))
pel_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_pel_hb_2013.tif"))
pel_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/impact/figures/impacts_lat_long/log_latlong/ln_latlong_pel_lb_2013.tif"))

# all scaled to demersal non destructive high bycatch

fish_plot_function(fis_rast=dd, cols=cols, saveFile="log_fis_dd_global", title="Fishing: demersal destructive (log)")

fish_plot_function(fis_rast=dnd_hb, cols=cols, saveFile="log_fis_dnd_hb_global", title = "Fishing: demersal nondestructive high bycatch (log)")

fish_plot_function(fis_rast=dnd_lb, cols=cols, saveFile="log_fis_dnd_lb_global", title="Fishing: demersal nondestructive low bycatch (log)")

fish_plot_function(fis_rast=pel_hb, cols=cols, saveFile="log_fis_pel_hb_global", title="Fishing: pelagic high bycatch (log)")

fish_plot_function(fis_rast=pel_lb, cols=cols, saveFile="log_fis_pel_lb_global", title = "Fishing: pelagic low bycatch (log)")


```

# Fisheries region zoom
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

fish_region_plot(raster_data=dd, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dd_cpps", cols=cols)

fish_region_plot(raster_data=dnd_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_hb_cpps", cols=cols)

fish_region_plot(raster_data=dnd_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_lb_cpps", cols=cols)

fish_region_plot(raster_data=pel_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_hb_cpps", cols=cols)

fish_region_plot(raster_data=pel_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_lb_cpps", cols=cols)


```

#### Make combined figs
```{r, echo = FALSE, message = FALSE, warning = FALSE}

global_region_plot(global_fig = "log_fis_dd_global", cpps_fig="log_dd_cpps", filename="log_fish_dd")

global_region_plot(global_fig = "log_fis_dnd_hb_global", cpps_fig="log_dnd_hb_cpps", filename="log_fish_ndd_hb")

global_region_plot(global_fig = "log_fis_dnd_lb_global", cpps_fig="log_dnd_lb_cpps", filename="log_fish_ndd_lb")

global_region_plot(global_fig = "log_fis_pel_hb_global", cpps_fig="log_pel_hb_cpps", filename="log_fish_pel_hb")

global_region_plot(global_fig = "log_fis_pel_lb_global", cpps_fig="log_pel_lb_cpps", filename="log_fish_pel_lb")

```



#Fisheries: Messing with scaling

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

cols = rev(colorRampPalette(c("#9E0142", "#AE1245", "#BE2449", "#CE364D", "#DA464C", "#E35449", "#EC6145", "#F47044", "#F7834D", "#F99756", "#FCAA5F",             
               "#FEF0A7", "#F3FAAD",  
              "#CAE99D", "#7ECBA4", "#3B92B8"))(254))


fish_plot_function_2 <- function(fis_rast, cols=cols, title="", saveFile){
  #cc_rast=sst
  #saveFile="sst_global"
  # cols=cols
png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=7, height=4, units="in")  
  par(mar=c(1,1,1,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(fis_rast, col=cols,  
     breaks=c(seq(minValue(dnd_hb),
                  maxValue(dnd_hb), length.out=254)), 
     legend=FALSE, axes=FALSE, box=FALSE)

title(main=list(title, cex=1.2), line=0)

plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
par(mfrow=c(1, 1), mar=c(2, 0, 1, 0), new=FALSE)
plot(dnd_hb, legend.only=TRUE, legend.shrink=.7, legend.width=.5, col=cols, axis.args = list(cex.axis = 0.6))
  dev.off()
}


dd <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_dem_dest_2013.tif"))
dnd_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_dem_nondest_hb_2013.tif"))
dnd_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_dem_nondest_lb_2013.tif"))
pel_hb <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_pel_hb_2013.tif"))
pel_lb <- raster(file.path(dir_M, "git-annex/impact_acceleration/paper/figures/impacts_lat_long/log_latlong/ln_latlong_pel_lb_2013.tif"))


fish_plot_function_2(fis_rast=dd, cols=cols, saveFile="log_fis_dd_global_v2", title="Fishing: demersal destructive (log)")

fish_plot_function_2(fis_rast=dnd_hb, cols=cols, saveFile="log_fis_dnd_hb_global_v2", title="Fishing: demersal nondestructive high bycatch (log)")

fish_plot_function_2(fis_rast=dnd_lb, cols=cols, saveFile="log_fis_dnd_lb_global_v2", title="Fishing: demersal nondestructive low bycatch (log)")

fish_plot_function_2(fis_rast=pel_hb, cols=cols, saveFile="log_fis_pel_hb_global_v2", title="Fishing: pelagic high bycatch (log)")

fish_plot_function_2(fis_rast=pel_lb, cols=cols, saveFile="log_fis_pel_lb_global_v2", title = "Fishing: pelagic low bycatch (log)")


```

# Fisheries region zoom
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

# this function does not scale the values to the highest one
fish_region_plot_2 <- function(raster_data, rgn_shape, crop_rgn, saveFile, cols){

## crop region
cc_crop <- crop(raster_data, crop_rgn)

## Save rasters of files
png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=5, height=4, units="in")  
  par(mar=c(1,1,0,1)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(c(crop_rgn[1], crop_rgn[2]), c(crop_rgn[3], crop_rgn[4]), 
     type="n", xaxs="i", yaxs="i", axes=FALSE)
plot(cc_crop, col=cols,  
     breaks=seq(minValue(raster_data),
                  maxValue(raster_data), length.out=255), 
     legend=FALSE, add=TRUE)
plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
plot(rgn_shape, add=TRUE, border="red", col=NA)
box("plot", col="gray")
  dev.off()
}


fish_region_plot_2(raster_data=dd, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dd_cpps_v2", cols=cols)

fish_region_plot_2(raster_data=dnd_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_hb_cpps_v2", cols=cols)

fish_region_plot_2(raster_data=dnd_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_lb_cpps_v2", cols=cols)

fish_region_plot_2(raster_data=pel_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_hb_cpps_v2", cols=cols)

fish_region_plot_2(raster_data=pel_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_lb_cpps_v2", cols=cols)


```

#### Make combined figs
```{r, echo = FALSE, message = FALSE, warning = FALSE}

global_region_plot(global_fig = "log_fis_dd_global_v2", cpps_fig="log_dd_cpps_v2", filename="log_fish_dd_v2")

global_region_plot(global_fig = "log_fis_dnd_hb_global_v2", cpps_fig="log_dnd_hb_cpps_v2", filename="log_fish_ndd_hb_v2")

global_region_plot(global_fig = "log_fis_dnd_lb_global_v2", cpps_fig="log_dnd_lb_cpps_v2", filename="log_fish_ndd_lb_v2")

global_region_plot(global_fig = "log_fis_pel_hb_global_v2", cpps_fig="log_pel_hb_cpps_v2", filename="log_fish_pel_hb_v2")

global_region_plot(global_fig = "log_fis_pel_lb_global_v2", cpps_fig="log_pel_lb_cpps_v2", filename="log_fish_pel_lb_v2")

```

## Option 3
No scaling to global values

```{r}

# this function does not scale the values to the highest one
fish_region_plot_3 <- function(raster_data, rgn_shape, crop_rgn, saveFile, cols){

## crop region
cc_crop <- crop(raster_data, crop_rgn)

## Save rasters of files
png(sprintf("projects/abnj/figures/ben_cpps_Oct19_2018_int/%s.png",  saveFile), 
    res=500, width=5.5, height=4, units="in")  
  par(mar=c(2,2,2,5)) # bottom, left, top, and right
  par(oma=c(0,0,0,0))

plot(c(crop_rgn[1], crop_rgn[2]), c(crop_rgn[3], crop_rgn[4]), 
     type="n", xaxs="i", yaxs="i", axes=FALSE)
plot(cc_crop, col=cols,  
     legend=FALSE, add=TRUE)
plot(land_wgs, add=TRUE, border="gray80", col="gray90", lwd=0.5)
plot(rgn_shape, add=TRUE, border="red", col=NA)
box("plot", col="gray")
par(mfrow=c(1, 1), mar=c(2, 0, 1, 0), new=FALSE)
plot(cc_crop, legend.only=TRUE, legend.shrink=.7, legend.width=.5, col=cols, axis.args = list(cex.axis = 0.6))
  dev.off()
}


cols = rev(colorRampPalette(c("#9E0142", "#AE1245", "#BE2449", "#CE364D", "#DA464C", "#E35449", "#EC6145", "#F47044", "#F7834D", "#F99756", "#FCAA5F",             
               "#FEF0A7", "#F3FAAD",  
              "#CAE99D", "#7ECBA4", "#3B92B8"))(254))
cols <- cols[c(1, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30:254)]

fish_region_plot_3(raster_data=dd, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dd_cpps_v3", cols=cols)

fish_region_plot_3(raster_data=dnd_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_hb_cpps_v3", cols=cols)

fish_region_plot_3(raster_data=dnd_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_dnd_lb_cpps_v3", cols=cols)

fish_region_plot_3(raster_data=pel_hb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_hb_cpps_v3", cols=cols)

fish_region_plot_3(raster_data=pel_lb, crop_rgn=cpps_extent, rgn_shape=cpps,  saveFile="log_pel_lb_cpps_v3", cols=cols)



```