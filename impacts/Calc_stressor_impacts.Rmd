---
title: "Calc_impacts"
output: html_document
---

Caculate impact for each stressor by summing the stressor x habitat x vulnerability rasters for each stressor, and then dividing by the number of habitats.

## Loading packages

```{r}
#libraries
library(raster)
library(RColorBrewer)
library(sf)
library(dplyr)
library(doParallel)
library(foreach)
library(parallel)

source("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/R/spatial_common.R")

# parallel processing

registerDoSEQ()
registerDoParallel(4)

```

## Habitat number raster
Create a raster that describes the number of habitats in each raster cell.

```{r}

habs <- list.files(file.path(dir_M, "git-annex/impact_acceleration/habitats"), full=TRUE)
habs <- habs[-(grep(".vat.dbf|.xml|.ovr", habs))]
hab_stack <- stack(habs)
calc(hab_stack, fun = sum, na.rm=TRUE, progress="text",
               filename=file.path(dir_M, "git-annex/impact_acceleration/habitat_number/habitat_num.tif"),
               overwrite=TRUE)

```

## Create a list of stressor/year combinations

```{r}
years <- 2003:2013

years_subset <- paste(years, collapse="|")

## Get a list of the stressor/year combinations:
stress_files <- list.files(file.path(dir_M, "git-annex/impact_acceleration/stressors"), recursive = TRUE, 
                           pattern = ".tif", full="TRUE")
stress_files <- grep("/final/", stress_files, value=TRUE)

stress_files <- basename(stress_files)
stress_files <- gsub("_rescaled_mol.tif", "", stress_files)


#filter to relevant years
stress_files <- grep(years_subset, stress_files, value=TRUE)


stress_combos <- data.frame(files = stress_files) %>%
  tidyr::separate(files, c("stressor", "year"), sep=-4) %>%
  mutate(stressor=substr(stressor, 1, nchar(stressor)-1)) 

```

## Check stressor data
All stressor/years should have 21 rasters, one for each habitat.

```{r}

hab_num <- raster(file.path(dir_M, "git-annex/impact_acceleration/habitat_number/habitat_num.tif"))

combos <- list.files(file.path(dir_M, "git-annex/impact_acceleration/hab_stressor_combo"), full=TRUE)

check_hab_count <- data.frame(N=rep(NA, dim(stress_combos)[1]), pressure_year=rep(NA, dim(stress_combos)[1]))

for(row in 1:dim(stress_combos)[1]){ # row=2

  year <- stress_combos$year[row]
  stress <- stress_combos$stressor[row]
  
  tmp <- grep(year, combos, value=TRUE)
  tmp <- grep(stress, tmp, value =TRUE)
  
  check_hab_count$N[row] = length(tmp)
  check_hab_count$pressure_year[row] = paste(stress, year, sep="_")

}

check_hab_count
table(check_hab_count$pressure_year)

```

## Create raster that sums all habitat x impacts for a stressor/year
For each stressor and year, identify the stressor x habitat x vulnerability rasters.  Sum these and then divide by the number of habitats.  

```{r}
hab_num <- raster(file.path(dir_M, "git-annex/impact_acceleration/habitat_number/habitat_num.tif"))

combos <- list.files(file.path(dir_M, "git-annex/impact_acceleration/hab_stressor_combo"), full=TRUE)

registerDoParallel(4)
foreach(row = 1:dim(stress_combos)[1]) %dopar%{ # row=1

  year <- stress_combos$year[row]
  stress <- stress_combos$stressor[row]
  
  tmp <- grep(year, combos, value=TRUE)
  tmp <- grep(stress, tmp, value =TRUE)
  
  stress_stack <- raster::stack(tmp)
  
  raster::calc(stress_stack, fun=sum, na.rm=TRUE,
      filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s.tif", stress, year)), 
      overwrite=TRUE)
  
  summed_rast <- raster::raster(file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s.tif", stress, year)))
  
  raster::overlay(summed_rast, hab_num, fun=function(x,y){x/y}, 
                  filename = file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s_rescaled.tif", stress, year)))

}

```

## Round 2
This process is very very slow and eventually, I seem to be kicked off Mazu cores and have to start over.  The following tracks which impact rasters have not been created and then resumes running the data. This is repeated until all rasters have been created.

```{r}
# identify rasters that have been created:
combos_obs <- list.files(file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp")))
combos_obs <- combos_obs[grep("_rescaled", combos_obs)]
combos_obs <- gsub("summed_raster_", "", combos_obs)
combos_obs <- gsub("_rescaled", "", combos_obs)

# compare them with the complete list
not_done <- setdiff(paste0(stress_combos$stressor, "_", stress_combos$year, ".tif"), combos_obs)
sort(not_done)
not_done <- gsub(".tif", "", not_done)
not_done <- data.frame(combo=not_done) %>%
  mutate(combo = as.character(combo))
not_done <- not_done %>%
  tidyr::separate(combo, c("stressor", "year"), sep=-4) %>%
  dplyr::mutate(stressor = substr(stressor, 1, nchar(stressor)-1))

combos <- list.files(file.path(dir_M, "git-annex/impact_acceleration/hab_stressor_combo"), full=TRUE)

hab_num <- raster(file.path(dir_M, "git-annex/impact_acceleration/habitat_number/habitat_num.tif"))

registerDoParallel(4)
foreach(row = 1:dim(not_done)[1]) %dopar%{ # row=1

  year <- not_done$year[row]
  stress <- not_done$stressor[row]
  
  tmp <- grep(year, combos, value=TRUE)
  tmp <- grep(stress, tmp, value =TRUE)
  
  stress_stack <- raster::stack(tmp)
  
  raster::calc(stress_stack, fun=sum, na.rm=TRUE,
               filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s.tif", stress, year)), 
               overwrite=TRUE)
  
  summed_rast <- raster::raster(file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s.tif", stress, year)))
  
  raster::overlay(summed_rast, hab_num, fun=function(x,y){x/y}, 
                  filename = file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s_%s_rescaled.tif", stress, year)))
  
}

```


## Ocean mask for each layer created above.
```{r}
rescaled_data <- list.files(file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp")), full=TRUE)
rescaled_data <- rescaled_data[grep("rescaled", rescaled_data)]

for(rescale in rescaled_data) { # rescale=rescaled_data[1]
  
 rescaled <- raster::raster(rescale)

 # get stressor and year from file name
stressor <- basename(rescale)
 stressor <- gsub("_rescaled.tif", "", stressor)
 stressor <- gsub("summed_raster_", "", stressor)
 stressor <- data.frame(combo=stressor)
 
 combo_data <- stressor %>% 
   tidyr::separate(combo, c("stressor", "year"), sep=-4) %>%
   dplyr::mutate(stressor = substr(stressor, 1, nchar(stressor)-1))
 
 # mask data and save
 raster::mask(rescaled, ocean,
                 filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/impact/stressor_impact/%s_%s.tif", 
                                                   combo_data$stressor, combo_data$year)),
                 overwrite=TRUE, progress="text")
 
}
