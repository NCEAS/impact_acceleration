---
title: 'Habitat data extraction and visualization'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../ohiprep_v2018/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
editor_options: 
  chunk_output_type: console
---


## set up

```{r setup, message=FALSE, warning=FALSE, verbose=FALSE}

#set options for all chunks in code
knitr::opts_chunk$set(warning=FALSE, message=FALSE,fig.width=6, fig.height=6)

#libraries
library(dplyr)
library(tidyr)

library(googleVis)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(RColorBrewer)

library(raster)

library(ohicore)

library(doParallel)
library(foreach)
library(parallel)

source("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/R/spatial_common.R")

cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme

# paralell processing
cl<-makeCluster(5)
registerDoParallel(cl)

```


## Habitat zones

```{r}

habs <- list.files(file.path(dir_M, "git-annex/impact_acceleration/habitats"), full=TRUE)
habs <- habs[-(grep(".vat.dbf|.xml|.ovr", habs))]

```


## Chi data

```{r}

chi <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/cumulative_impact"), full=TRUE)

chi_stack <- stack(chi)

#foreach(hab = habs,.packages="dplyr")%dopar% { # hab = habs[1]
for(hab in habs){
  
  habitat_name <- gsub(".tif", "", basename(hab))
  
  zone <- raster::raster(hab)
  
hab_data <- raster::zonal(chi_stack, zone, fun="mean", progress="text", na.rm=TRUE)

hab_data_df <- data.frame(hab_data) %>%
  tidyr::gather("pressure", "value", -1) %>%
  dplyr::rename("habitat" = zone) %>%
  dplyr::mutate(year = as.numeric(substring(pressure, 5, 8))) %>%
  dplyr::mutate(pressure = "chi") %>%
  dplyr::mutate(habitat=habitat_name)

write.csv(hab_data_df, sprintf("impacts/zonal_data_habitat/%s_chi.csv", habitat_name), row.names=FALSE)
}

```

## Trend data

```{r}


trend <- raster(file.path(dir_M, "git-annex/impact_acceleration/trend/chi_coef_slope.tif"))

hab_data_df <- data.frame()
#foreach(hab = habs,.packages="dplyr")%dopar% { # hab = habs[1]
for(hab in habs){
  
  habitat_name <- gsub(".tif", "", basename(hab))
  
  zone <- raster::raster(hab)
  
hab_data <- raster::zonal(trend, zone, fun="mean", progress="text", na.rm=TRUE)

hab_data_tmp <- data.frame(hab_data) %>%
  dplyr::rename("habitat" = zone) %>%
  dplyr::mutate(habitat=habitat_name)

hab_data_df <- rbind(hab_data_tmp, hab_data_df)

}

write.csv(hab_data_df, "impacts/zonal_data_habitat/chi_trend.csv", row.names=FALSE)

```


## Pressure extract

```{r}

########### Years

years <- 2003:2013

years_subset <- paste(years, collapse="|")


####### Stressors
stress_files <- list.files(file.path(dir_M, "git-annex/impact_acceleration/stressors"), recursive = TRUE, 
           pattern = ".tif", full="TRUE")
stress_files <- grep("/final/", stress_files, value=TRUE)

#filter to relevant years
stress_files <- grep(years_subset, stress_files, value=TRUE)

stress_stack <- stack(stress_files)

#foreach(hab = habs,.packages="dplyr")%dopar% { # hab = habs[1]
for(hab in habs){ # hab <- habs[1]
  
  habitat_name <- gsub(".tif", "", basename(hab))
  
  zone <- raster::raster(hab)
  
hab_data <- raster::zonal(stress_stack, zone, fun="mean", progress="text", na.rm=TRUE)

hab_data_df <- data.frame(hab_data) %>%
  tidyr::gather("pressure", "value", -1) %>%
  dplyr::rename("habitat" = zone) %>%
  dplyr::mutate(pressure = gsub("_rescaled_mol", "", pressure)) %>%
  dplyr::mutate(year = as.numeric(stringr::str_sub(pressure, -4,-1))) %>%
  dplyr::mutate(pressure = stringr::str_sub(pressure, 1, stringr::str_length(pressure)-5)) %>%
  dplyr::mutate(habitat=habitat_name)

write.csv(hab_data_df, sprintf("impacts/zonal_data_habitat/%s_pressure.csv", habitat_name), row.names=FALSE)
}

```


## Combine habitat chi data

```{r}

habs <- list.files("zonal_data_habitat", full=TRUE, pattern="_chi")

habitat_chi <- data.frame()

for(hab in habs){ # hab=habs[1]
  tmp <- read.csv(hab)
  habitat_chi <- rbind(habitat_chi, tmp)
}

write.csv(habitat_chi, "zonal_data_habitat/habitat_chi.csv", row.names=FALSE)

```


### Visualize habitat CHI data

Heat map
```{r}
hab_data <- read.csv("impacts/zonal_data_habitat/habitat_chi.csv")

avg <- hab_data %>%
  group_by(habitat) %>%
  summarize(average=mean(value))

plot_data <- hab_data %>%
  left_join(avg, by="habitat") %>%
  arrange(average)

plot_data$habitat <- factor(plot_data$habitat, 
                             levels = avg$habitat[order(avg$average, decreasing = TRUE)])

cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # 

tmp <- ggplot(plot_data, aes(y=year, x=habitat, text=)) +
  geom_tile(aes(fill=value, 
                text=sprintf("habitat: %s \nyear: %s \npressure: %s" , habitat, year, round(value, 2))), color="white") +
  scale_fill_gradientn(colors=rev(brewer.pal(11, 'Spectral'))) +
  ylab("Year") +
  xlab("") +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text.x=element_text(angle=90, hjust=1)) 

tmp_plotly <- ggplotly(tmp, tooltip = "text")
htmlwidgets::saveWidget(widget=tmp_plotly, "habitat_chi_heat.html", selfcontained = TRUE)

```

## Trend and CHI summary
```{r}

hab_chi <- read.csv("impacts/zonal_data_habitat/habitat_chi.csv") %>%
  group_by(habitat) %>%
  summarize(chi_average=mean(value))

hab_data <- read.csv("impacts/zonal_data_habitat/chi_trend.csv") %>%
  rename(trend = mean) %>%
  left_join(hab_chi, by="habitat") %>%
  arrange(chi_average)
  
library(ggrepel)
ggplot(hab_data, aes(x=chi_average, y=trend)) +
  geom_point(size=3, alpha=0.5, shape=19) +
  geom_text_repel(aes(label = habitat),
                 # box.padding   = 0.35, 
                #  point.padding = 0.5,
                  segment.color = 'grey50',
                segment.size = 0.2,
                size = 3) + 
  #geom_text(aes(label=habitat))+
  theme_bw()

```